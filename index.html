<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LaunchRamp</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#1a1a1a;--surface:#262624;--surface2:#2f2f2c;--surface3:#3a3a36;
  --accent:#e8913a;--accent-bg:rgba(232,145,58,.12);--accent-hover:#f0a050;
  --green:#4ade80;--green-bg:rgba(74,222,128,.1);
  --yellow:#facc15;--yellow-bg:rgba(250,204,21,.1);
  --red:#f87171;--red-bg:rgba(248,113,113,.1);
  --pink:#f472b6;--pink-bg:rgba(244,114,182,.1);
  --blue:#60a5fa;--blue-bg:rgba(96,165,250,.1);
  --purple:#a78bfa;--purple-bg:rgba(167,139,250,.1);
  --text:#e8e4df;--text2:#a8a29e;--text3:#6b6560;
  --border:#3a3835;--border2:#4a4743;
  --radius:10px;--radius-sm:7px;--radius-xs:5px;
  --shadow:0 1px 3px rgba(0,0,0,.2);
  --shadow-md:0 4px 12px rgba(0,0,0,.25);
  --shadow-lg:0 10px 30px rgba(0,0,0,.35);
  --tr:all .15s ease;
}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;font-size:14px;-webkit-font-smoothing:antialiased}
::selection{background:rgba(232,145,58,.3);color:var(--accent)}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
button,select,input,textarea{font-family:inherit}

/* ===== LAYOUT ===== */
.app{display:flex;height:100vh;overflow:hidden}

/* SIDEBAR */
.sidebar{width:250px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:18px 16px;border-bottom:1px solid var(--border)}
.sidebar-logo{display:flex;align-items:center;gap:9px;margin-bottom:14px}
.sidebar-logo svg{width:26px;height:26px}
.sidebar-logo h1{font-size:15px;font-weight:700;letter-spacing:-.3px}
.sidebar-logo span{font-size:10px;color:var(--text3);display:block;margin-top:-1px}
.new-client-btn{width:100%;padding:8px 12px;background:var(--accent);color:#1a1a1a;border:none;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;transition:var(--tr);display:flex;align-items:center;gap:6px;justify-content:center}
.new-client-btn:hover{opacity:.85}
.client-list{flex:1;overflow-y:auto;padding:6px}
.client-item{padding:9px 12px;border-radius:var(--radius-sm);cursor:pointer;transition:var(--tr);display:flex;align-items:center;justify-content:space-between;margin-bottom:1px;position:relative}
.client-item:hover{background:var(--surface2)}
.client-item.active{background:var(--accent-bg);color:var(--accent)}
.client-item .ci-name{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;font-weight:500}
.client-item .ci-pct{font-size:11px;color:var(--text3);font-weight:600;min-width:30px;text-align:right}
.client-item.active .ci-pct{color:var(--accent)}
.client-item .ci-del{display:none;font-size:10px;color:var(--red);cursor:pointer;padding:2px 5px;border-radius:4px;position:absolute;right:3px;top:50%;transform:translateY(-50%)}
.client-item:hover .ci-del{display:block}
.client-item .ci-del:hover{background:var(--red-bg)}
.ci-group{margin-bottom:2px}
.ci-group-active>.client-item{font-weight:600}
.ci-projects{padding-left:12px;padding-bottom:4px}
.proj-item{padding:5px 10px;border-radius:var(--radius-xs);cursor:pointer;display:flex;align-items:center;font-size:12px;margin-bottom:1px;transition:var(--tr);position:relative}
.proj-item:hover{background:var(--surface2)}
.proj-item.active{background:var(--accent-bg);color:var(--accent)}
.proj-item.completed{opacity:.45}
.proj-item.completed .proj-name{text-decoration:line-through}
.proj-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.proj-pct{font-size:10px;color:var(--text3);min-width:26px;text-align:right;margin-right:2px}
.proj-item.active .proj-pct{color:var(--accent)}
.proj-del{display:none;font-size:9px;color:var(--red);cursor:pointer;padding:1px 4px;border-radius:3px;position:absolute;right:2px}
.proj-item:hover .proj-del{display:block}
.proj-del:hover{background:var(--red-bg)}
.proj-add{padding:4px 10px;font-size:11px;color:var(--text3);cursor:pointer;border-radius:var(--radius-xs);transition:var(--tr)}
.proj-add:hover{color:var(--accent);background:var(--accent-bg)}
.ret-cat-label{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:14px 8px;background:var(--surface2);border-radius:var(--radius-sm);cursor:pointer;font-size:12px;font-weight:500;border:2px solid transparent;transition:var(--tr);text-align:center;min-height:70px;user-select:none;-webkit-tap-highlight-color:transparent}
.ret-cat-label:hover{background:var(--surface3);border-color:var(--border2)}
.ret-cat-label.selected{border-color:var(--accent);background:var(--accent-bg)}
.ret-cat-icon{font-size:22px;line-height:1}
.ret-cat-name{font-size:11px;color:var(--text2);line-height:1.2}
.ret-cat-label.selected .ret-cat-name{color:var(--accent);font-weight:600}
.sidebar-footer{padding:12px 14px;border-top:1px solid var(--border);font-size:10px;color:var(--text3)}

/* MAIN */
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

/* TOPBAR */
.topbar{padding:14px 24px;border-bottom:1px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;min-height:56px}
.topbar-left{display:flex;align-items:center;gap:14px;flex:1;min-width:0}
.client-title{font-size:18px;font-weight:700;letter-spacing:-.3px;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.client-title:hover{border-bottom-color:var(--accent)}
.client-title-input{font-size:18px;font-weight:700;letter-spacing:-.3px;border:none;border-bottom:2px solid var(--accent);background:transparent;outline:none;color:var(--text);display:none;width:280px}
.timeline-bar{display:flex;align-items:center;gap:10px;padding:6px 24px;border-bottom:1px solid var(--border);background:var(--surface)}
.timeline-bar label{font-size:11px;color:var(--text3);font-weight:500;flex-shrink:0}
.timeline-bar input[type=date]{border:1px solid var(--border);border-radius:var(--radius-xs);padding:4px 8px;font-size:12px;color:var(--text);background:var(--surface2);cursor:pointer;flex-shrink:0}
.countdown{font-size:11px;font-weight:600;padding:3px 9px;border-radius:14px;white-space:nowrap;flex-shrink:0}
.topbar-actions{display:flex;gap:5px;flex-shrink:0}
.btn{padding:6px 12px;border:1px solid var(--border);background:var(--surface);color:var(--text2);border-radius:var(--radius-sm);font-size:12px;font-weight:500;cursor:pointer;transition:var(--tr);white-space:nowrap}
.btn:hover{background:var(--surface2);border-color:var(--border2)}
.btn.on{background:var(--accent-bg);color:var(--accent);border-color:var(--accent)}
.btn.primary{background:var(--accent);color:#1a1a1a;border-color:var(--accent);font-weight:600}
.btn.primary:hover{opacity:.85}
.btn.sm{padding:4px 8px;font-size:11px}
.btn.danger{color:var(--red);border-color:var(--red-bg)}
.btn.danger:hover{background:var(--red-bg)}

/* VIEW TABS */
.view-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface);padding:0 24px}
.vtab{padding:9px 16px;font-size:13px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:var(--tr);user-select:none}
.vtab:hover{color:var(--text2)}
.vtab.active{color:var(--text);border-bottom-color:var(--accent)}

/* FILTERS */
.filters-bar{padding:8px 24px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.flabel{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-right:1px}
.pill{padding:3px 9px;border-radius:14px;font-size:11px;font-weight:500;cursor:pointer;transition:var(--tr);border:1px solid var(--border);background:transparent;color:var(--text3)}
.pill:hover{background:var(--surface2);color:var(--text2)}
.pill.active{background:var(--accent);color:#1a1a1a;border-color:var(--accent);font-weight:600}
.search-box{margin-left:auto;border:1px solid var(--border);border-radius:16px;padding:4px 12px;font-size:12px;color:var(--text);background:var(--surface2);outline:none;width:180px;transition:var(--tr)}
.search-box:focus{border-color:var(--accent);background:var(--surface);width:220px}

/* STATS */
.stats-row{display:flex;gap:1px;padding:0;background:var(--border)}
.stat-card{background:var(--surface);padding:10px 16px;flex:1;text-align:center}
.stat-num{font-size:20px;font-weight:700;letter-spacing:-.5px}
.stat-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-top:1px}
.stat-sub{font-size:10px;color:var(--text3);margin-top:1px}
.progress-track{height:3px;background:var(--surface2);display:flex;margin:0}
.progress-seg{height:100%;transition:width .4s}

/* CONTENT */
.content{flex:1;overflow-y:auto;padding:16px 24px 80px}

/* ===== TASKS VIEW ===== */
.tasks-view{display:none}
.tasks-view.active{display:block}
.phase-block{margin-bottom:12px;transition:transform .15s,opacity .15s}
.phase-block.drag-over-top{border-top:3px solid var(--accent);margin-top:-3px}
.phase-block.drag-over-bot{border-bottom:3px solid var(--accent);margin-bottom:-3px}
.phase-block.dragging{opacity:.4;transform:scale(.97)}
.drag-handle{cursor:grab;font-size:11px;color:var(--text3);opacity:.3;transition:opacity .15s;padding:0 4px;user-select:none}
.drag-handle:hover{opacity:.8}
.drag-handle:active{cursor:grabbing}
.wp-wrap{transition:transform .1s,opacity .1s}
.wp-wrap.drag-over-top{border-top:2px solid var(--accent)}
.wp-wrap.drag-over-bot{border-bottom:2px solid var(--accent)}
.wp-wrap.dragging{opacity:.4}
.phase-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:var(--tr);user-select:none}
.phase-head:hover{box-shadow:var(--shadow)}
.phase-left{display:flex;align-items:center;gap:8px;min-width:0;flex:1}
.ph-chev{font-size:9px;color:var(--text3);transition:transform .15s;display:inline-block;width:10px}
.ph-chev.open{transform:rotate(90deg)}
.ph-tag{font-size:9px;font-weight:700;padding:2px 7px;border-radius:var(--radius-xs);letter-spacing:.3px}
.ph-name{font-size:13px;font-weight:600;letter-spacing:-.1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.phase-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.phase-pct{font-size:11px;color:var(--text3);font-weight:500}
.mini-bar{width:50px;height:3px;background:var(--surface2);border-radius:2px;overflow:hidden}
.mini-fill{height:100%;border-radius:2px;transition:width .3s}
.phase-dates{font-size:10px;color:var(--text3);display:flex;gap:4px;align-items:center}
.phase-dates input{border:1px solid var(--border);border-radius:var(--radius-xs);padding:2px 4px;font-size:10px;color:var(--text2);background:var(--surface2);cursor:pointer;width:105px}
.ph-actions{display:flex;gap:3px;opacity:0;transition:opacity .15s}
.phase-head:hover .ph-actions{opacity:1}

.phase-body{display:none;padding:6px 0 0}
.phase-body.open{display:block}

.wp-head{display:flex;align-items:center;gap:6px;padding:6px 14px;cursor:pointer;user-select:none;margin-top:2px}
.wp-head:hover .wp-name{color:var(--text)}
.wp-head:hover .btn{opacity:1 !important}
.wp-chev{font-size:7px;color:var(--text3);transition:transform .12s;display:inline-block;width:8px}
.wp-chev.open{transform:rotate(90deg)}
.wp-name{font-size:12px;font-weight:600;color:var(--text2);transition:color .12s}
.wp-body{display:none;padding:0 0 2px}
.wp-body.open{display:block}

/* TASK ROW */
.task-row{display:grid;grid-template-columns:28px 1fr auto auto auto auto 120px 80px auto 28px;gap:6px;align-items:center;padding:7px 14px;border-radius:var(--radius-xs);transition:background .1s;min-height:38px}
.task-row:hover{background:var(--surface2)}
.task-row.done{opacity:.4}
.task-row.done .task-text{text-decoration:line-through}
.task-row.opt-row{opacity:.65}
.client-view .int-col{display:none !important}
.client-view .task-row{grid-template-columns:28px 1fr auto auto auto auto 120px 80px auto}
.dl-badge{font-size:9px;font-weight:600;padding:2px 7px;border-radius:10px;white-space:nowrap;line-height:1.3}
.dl-badge.dl-ok{background:var(--green-bg);color:var(--green)}
.dl-badge.dl-warn{background:var(--yellow-bg);color:var(--yellow)}
.dl-badge.dl-over{background:var(--red-bg);color:var(--red)}
.dl-badge.dl-done{background:var(--surface2);color:var(--text3);text-decoration:line-through}

.link-btn{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:600;padding:2px 8px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;transition:var(--tr);white-space:nowrap;text-decoration:none;line-height:1.3}
.link-btn:hover{background:var(--accent-bg);border-color:var(--accent);color:var(--accent)}
.link-btn.has-link{background:var(--green-bg);border-color:var(--green);color:var(--green)}
.link-btn .gear{font-size:8px;opacity:.5;cursor:pointer}
.link-btn .gear:hover{opacity:1}
.link-btn.empty{opacity:.4;border-style:dashed}
.link-btn.empty:hover{opacity:.8}
.qlinks{display:flex;gap:4px;align-items:center;flex-shrink:0;flex-wrap:wrap}
.qlink{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:12px;border:1px dashed var(--border);background:var(--surface2);color:var(--text3);cursor:pointer;transition:var(--tr);font-size:10px;font-weight:600;opacity:.45;white-space:nowrap;line-height:1.3}
.qlink:hover{opacity:.85;border-color:var(--accent);background:var(--accent-bg);color:var(--accent)}
.qlink.active{opacity:1;border-style:solid;border-color:var(--green);background:var(--green-bg);color:var(--green);position:relative;padding-right:22px}
.qlink.active:hover{background:var(--green);color:#1a1a1a}
.qlink-edit{position:absolute;right:3px;top:50%;transform:translateY(-50%);width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;opacity:0;transition:var(--tr);background:rgba(0,0,0,.1)}
.qlink.active:hover .qlink-edit{opacity:1}
.qlink-edit:hover{background:rgba(0,0,0,.25)}

.time-btn{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:600;padding:2px 8px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;transition:var(--tr);white-space:nowrap;line-height:1.3}
.time-btn:hover{background:var(--blue-bg);border-color:var(--blue);color:var(--blue)}
.cal-btn{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:600;padding:2px 8px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;transition:var(--tr);white-space:nowrap;text-decoration:none;line-height:1.3}
.cal-btn:hover{background:var(--green-bg);border-color:var(--green);color:var(--green)}
.cal-btn.cal-scheduled{background:var(--green-bg);border-color:var(--green);color:var(--green);font-weight:700}

.tcheck{width:18px;height:18px;border:2px solid var(--border2);border-radius:5px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--tr);font-size:10px;font-weight:700;flex-shrink:0}
.tcheck.done{background:var(--green);border-color:var(--green);color:#1a1a1a}
.tcheck.wip{background:var(--yellow);border-color:var(--yellow);color:#1a1a1a}
.tcheck.wait{background:var(--pink);border-color:var(--pink);color:#1a1a1a}
.tcheck:hover{border-color:var(--text3)}

.task-text{font-size:12px;line-height:1.3;display:flex;align-items:center;gap:5px;min-width:0}
.task-text .txt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:default}
.task-text .txt:hover{text-decoration:underline;text-decoration-style:dotted;cursor:pointer}
.opt-tag{font-size:8px;background:var(--surface3);color:var(--text3);padding:1px 5px;border-radius:3px;flex-shrink:0}
.ki-dot{width:5px;height:5px;border-radius:50%;background:var(--pink);flex-shrink:0}

.ssel{background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:4px 6px;border-radius:var(--radius-xs);font-size:11px;cursor:pointer;width:100%;appearance:none;-webkit-appearance:none;padding-right:16px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%23999'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 5px center}

.opill{font-size:10px;font-weight:600;padding:3px 10px;border-radius:12px;text-align:center;white-space:nowrap;cursor:pointer;border:none;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='6' height='4'%3E%3Cpath d='M0 0l3 4 3-4z' fill='%23999'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 4px center;padding-right:16px}
.opill-mitch{background:rgba(250,204,21,.15);color:#facc15}
.opill-max{background:rgba(74,222,128,.12);color:#4ade80}
.opill-hussein{background:rgba(96,165,250,.12);color:#60a5fa}
.opill-tobie{background:rgba(248,113,113,.12);color:#f87171}
.opill-team{background:rgba(167,139,250,.12);color:#a78bfa}
.opill-kunde{background:rgba(244,114,182,.12);color:#f472b6}

.abadge{font-size:9px;padding:2px 7px;border-radius:10px;text-align:center;white-space:nowrap}
.abadge-voll{background:rgba(74,222,128,.12);color:#4ade80}
.abadge-hoch{background:rgba(96,165,250,.12);color:#60a5fa}
.abadge-mittel{background:rgba(250,204,21,.15);color:#facc15}
.abadge-niedrig,.abadge-manuell{background:var(--surface2);color:var(--text3)}

.task-actions{display:flex;gap:2px;opacity:0;transition:opacity .1s}
.task-row:hover .task-actions{opacity:1}
.task-action{background:none;border:none;cursor:pointer;font-size:11px;padding:2px;border-radius:3px;color:var(--text3);transition:var(--tr)}
.task-action:hover{color:var(--red);background:var(--red-bg)}

.add-row{padding:4px 14px;margin-top:2px}
.add-btn{font-size:11px;color:var(--text3);cursor:pointer;padding:5px 10px;border:1.5px dashed var(--border2);border-radius:var(--radius-sm);display:inline-flex;align-items:center;gap:4px;transition:var(--tr);background:var(--surface2)}
.add-btn:hover{color:var(--accent);border-color:var(--accent);background:var(--accent-bg)}

/* ===== DOCS VIEW ===== */
.docs-view{display:none}
.docs-view.active{display:block}
.docs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.doc-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;cursor:pointer;transition:var(--tr);position:relative}
.doc-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
.doc-card.has-link{border-left:3px solid var(--green)}
.doc-icon{font-size:24px;margin-bottom:6px}
.doc-name{font-size:13px;font-weight:600;margin-bottom:1px}
.doc-desc{font-size:11px;color:var(--text3)}
.doc-link-btn{position:absolute;top:6px;right:6px;font-size:13px;background:none;border:none;color:var(--text3);padding:2px;border-radius:var(--radius-xs);cursor:pointer;opacity:0;transition:var(--tr);line-height:1;width:22px;height:22px;display:flex;align-items:center;justify-content:center}
.doc-card:hover .doc-link-btn{opacity:.5}
.doc-link-btn:hover{opacity:1!important;background:var(--accent-bg);color:var(--accent)}

/* JOURFIX */
.jf-section{margin-top:20px}
.sec-title{font-size:14px;font-weight:700;letter-spacing:-.1px;margin-bottom:10px}
.jf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.jf-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:var(--tr)}
.jf-card.hl{border-color:var(--accent);background:linear-gradient(135deg,var(--surface2),var(--accent-bg))}
.jf-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-bottom:3px}
.jf-val{font-size:14px;font-weight:600}
.jf-sub{font-size:11px;color:var(--text3);margin-top:1px}
.jf-notes{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:var(--radius-sm);font-size:11px;resize:vertical;min-height:50px;margin-top:4px}
.jf-notes:focus{outline:none;border-color:var(--accent)}

/* TIME TRACKER */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(6px);animation:modalBgIn .2s ease}
.modal-overlay .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px 28px 24px;box-shadow:0 24px 80px rgba(0,0,0,.5),0 0 0 1px rgba(255,255,255,.04);animation:modalIn .25s cubic-bezier(.175,.885,.32,1.1);max-width:90vw;color:var(--text)}
@keyframes modalBgIn{from{opacity:0}to{opacity:1}}
@keyframes modalIn{from{opacity:0;transform:scale(.92) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal h3{font-size:17px;font-weight:800;color:var(--text);letter-spacing:-.3px}
.modal .modal-subtitle{font-size:13px;color:var(--text2);margin-bottom:18px;line-height:1.4}
.modal .modal-label{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.modal input,.modal select{padding:10px 12px;border:1.5px solid var(--border2);border-radius:10px;font-size:13px;background:var(--surface2);color:var(--text);transition:border-color .15s,box-shadow .15s;box-sizing:border-box;width:100%}
.modal input:focus,.modal select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,145,58,.12)}
.modal input::placeholder{color:var(--text3)}
.modal .modal-preview{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--text2);line-height:1.5}
.modal .btn-row{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;flex-wrap:wrap}
.modal .btn-cancel{padding:10px 18px;border:1.5px solid var(--border2);border-radius:10px;background:var(--surface2);color:var(--text2);cursor:pointer;font-size:13px;font-weight:500;transition:all .15s}
.modal .btn-cancel:hover{background:var(--surface3);border-color:var(--border2)}
.modal .btn-primary{padding:10px 20px;border:none;border-radius:10px;background:var(--accent);color:#1a1a1a;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;box-shadow:0 2px 8px rgba(232,145,58,.25)}
.modal .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(232,145,58,.35)}
.modal .btn-danger{padding:10px 14px;border:1.5px solid rgba(248,113,113,.3);border-radius:10px;background:var(--red-bg);color:var(--red);cursor:pointer;font-size:12px;font-weight:500;margin-right:auto;transition:all .15s}
.modal .btn-danger:hover{background:var(--red-bg);border-color:var(--red)}
.modal .tpl-grid{display:flex;gap:10px;margin-bottom:20px}
.modal .tpl-option{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 12px;border:2px solid var(--border2);border-radius:12px;cursor:pointer;transition:all .15s;background:var(--surface2);text-align:center;color:var(--text)}
.modal .tpl-option:hover{border-color:var(--text3);background:var(--surface3)}
.modal .tpl-option.active{border-color:var(--accent);background:var(--accent-bg);box-shadow:0 0 0 3px rgba(232,145,58,.15)}
.modal .tpl-option .tpl-icon{font-size:24px;line-height:1}
.modal .tpl-option .tpl-label{font-size:12px;font-weight:700;color:var(--text)}
.timer-btn{font-size:10px;padding:2px 6px;border-radius:10px;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text3);transition:var(--tr);white-space:nowrap;display:inline-flex;align-items:center;gap:3px}
.timer-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-bg)}
.timer-btn.running{border-color:var(--red);background:var(--red-bg);color:var(--red);animation:timerPulse 1.5s infinite}
.timer-btn .tracked{font-size:9px;color:var(--green);font-weight:600;margin-left:2px}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:.7}}

/* ===== MODALS ===== */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal-bg.show{display:flex}
.modal{background:var(--surface);border-radius:var(--radius);padding:24px;width:90%;max-width:400px;box-shadow:var(--shadow-lg)}
.modal h3{font-size:16px;font-weight:700;margin-bottom:14px}
.mf{margin-bottom:12px}
.mf label{display:block;font-size:11px;color:var(--text3);margin-bottom:3px;font-weight:500}
.mf input,.mf select,.mf textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:var(--radius-sm);font-size:12px;outline:none;transition:var(--tr)}
.mf input:focus,.mf textarea:focus{border-color:var(--accent)}
.mf-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.modal-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:16px}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--surface3);color:var(--text);padding:8px 18px;border-radius:var(--radius);font-size:12px;font-weight:500;transition:transform .3s;z-index:600;box-shadow:var(--shadow-lg);border:1px solid var(--border2)}
.toast.show{transform:translateX(-50%) translateY(0)}

/* CONTEXT MENU */
.ctx-menu{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);z-index:400;padding:4px 0;min-width:140px;display:none}
.ctx-menu.show{display:block}
.ctx-item{padding:6px 14px;font-size:12px;cursor:pointer;transition:background .1s;display:flex;align-items:center;gap:6px}
.ctx-item:hover{background:var(--surface2)}
.ctx-item.danger{color:var(--red)}
.ctx-item.danger:hover{background:var(--red-bg)}

/* RESPONSIVE */
@media(max-width:768px){
  .sidebar{display:none}
  .topbar{padding:10px 14px}
  .view-tabs{padding:0 14px}
  .filters-bar{padding:6px 14px}
  .content{padding:10px 14px 80px}
  .task-row{grid-template-columns:24px 1fr 100px 60px;font-size:11px;padding:5px 8px}
  .task-row .abadge,.task-row .task-actions,.task-row .link-btn{display:none !important}
  .client-view .task-row{grid-template-columns:24px 1fr 100px 60px}
  .docs-grid{grid-template-columns:1fr 1fr}
  .jf-grid{grid-template-columns:1fr}
  .search-box{width:120px}
}

/* ===== DASHBOARD ===== */
.dashboard{display:none;flex:1;overflow-y:auto;padding:24px;background:var(--bg)}
.dashboard.active{display:block}
.dash-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.dash-title{font-size:22px;font-weight:700;letter-spacing:-.5px}
.dash-subtitle{font-size:12px;color:var(--text3);margin-top:2px}
.dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:24px}
.dash-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;cursor:pointer;transition:var(--tr)}
.dash-card:hover{border-color:var(--accent);box-shadow:var(--shadow-md);transform:translateY(-1px)}
.dash-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.dash-card-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dash-card-pct{font-size:12px;font-weight:700;padding:2px 8px;border-radius:10px}
.dash-card-bar{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;margin-bottom:8px}
.dash-card-fill{height:100%;border-radius:2px;transition:width .3s ease}
.dash-card-meta{display:flex;gap:12px;font-size:10px;color:var(--text3)}
.dash-card-meta span{display:flex;align-items:center;gap:3px}
.dash-section{margin-bottom:24px}
.dash-section-title{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.dash-section-title .badge{font-size:10px;font-weight:700;padding:1px 7px;border-radius:8px;color:#fff}
.dash-table{width:100%;border-collapse:collapse;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.dash-table th{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);padding:8px 12px;text-align:left;background:var(--surface2);border-bottom:1px solid var(--border)}
.dash-table td{font-size:12px;padding:8px 12px;border-bottom:1px solid var(--border)}
.dash-table tr:last-child td{border-bottom:none}
.dash-table tr:hover td{background:var(--surface2)}
.dash-table .client-link{color:var(--accent);cursor:pointer;font-weight:600}
.dash-table .client-link:hover{text-decoration:underline}
.dash-owner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.dash-owner-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px}
.dash-owner-name{font-size:13px;font-weight:700;margin-bottom:6px}
.dash-owner-stats{display:flex;gap:10px;font-size:11px;color:var(--text2)}
.dash-owner-bar{height:3px;background:var(--surface3);border-radius:2px;margin-top:6px;overflow:hidden}
.dash-owner-fill{height:100%;background:var(--accent);border-radius:2px}
.dash-empty{text-align:center;padding:40px;color:var(--text3);font-size:13px}
.main-area .client-view{display:flex;flex-direction:column;flex:1;overflow:hidden}
.main-area .client-view.hidden{display:none}
/* Plan vs Ist Progress Bar */
.plan-bar{display:inline-flex;align-items:center;gap:4px;margin-left:6px;font-size:10px;color:#888;cursor:default}
.plan-bar-track{width:48px;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;position:relative}
.plan-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.plan-bar-fill.green{background:#4caf50}
.plan-bar-fill.yellow{background:#ff9800}
.plan-bar-fill.red{background:#f44336}
.plan-bar-label{white-space:nowrap}
.pkg-time{font-size:10px;color:#999;margin-left:8px;font-weight:400}
.phase-time{font-size:10px;color:#999;margin-left:8px;font-weight:400}
/* M3: Activity Feed */
.activity-badge{position:absolute;top:-6px;right:-6px;background:#e74c3c;color:#fff;border-radius:50%;width:18px;height:18px;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:700;pointer-events:none}
.activity-panel{position:fixed;top:0;right:-340px;width:340px;height:100vh;background:var(--surface,#141414);border-left:1px solid var(--border,#333);z-index:10000;transition:right 0.3s ease;display:flex;flex-direction:column;box-shadow:-4px 0 20px rgba(0,0,0,0.3)}
.activity-panel.open{right:0}
.activity-panel-header{padding:16px;border-bottom:1px solid var(--border,#333);display:flex;justify-content:space-between;align-items:center}
.activity-panel-header h3{margin:0;font-size:15px;color:var(--text,#e0e0e0)}
.activity-panel-close{background:none;border:none;color:var(--text-dim,#888);font-size:20px;cursor:pointer;padding:4px 8px}
.activity-panel-close:hover{color:var(--text,#e0e0e0)}
.activity-list{flex:1;overflow-y:auto;padding:8px}
.activity-item{padding:10px 12px;border-bottom:1px solid var(--border,#222);font-size:13px;line-height:1.4;animation:actFadeIn 0.3s ease}
.activity-item:last-child{border-bottom:none}
.activity-item .act-time{color:var(--text-dim,#666);font-size:11px;margin-bottom:2px}
.activity-item .act-actor{color:var(--accent,#00b894);font-weight:600}
.activity-item .act-action{color:var(--text,#ccc)}
.activity-empty{padding:40px 20px;text-align:center;color:var(--text-dim,#666);font-size:13px}
@keyframes actFadeIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.sync-wrap{position:relative;display:inline-block}
/* M4: Template Settings */
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:12px 0}
.tpl-card{background:var(--surface2,#1e1e1e);border:1px solid var(--border,#333);border-radius:10px;padding:16px;cursor:pointer;transition:border-color 0.2s}
.tpl-card:hover{border-color:var(--accent,#60a5fa)}
.tpl-card.active{border-color:var(--accent,#60a5fa);box-shadow:0 0 0 1px var(--accent,#60a5fa)}
.tpl-card h4{margin:0 0 4px;font-size:14px}
.tpl-card .tpl-type{font-size:11px;opacity:0.5;text-transform:uppercase;letter-spacing:0.5px}
.tpl-card .tpl-stats{font-size:12px;opacity:0.6;margin-top:8px}
.tpl-editor{margin-top:16px}
.tpl-toolbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.tpl-toolbar button{padding:4px 12px;border-radius:6px;border:1px solid var(--border,#333);background:var(--surface2,#1e1e1e);color:inherit;cursor:pointer;font-size:12px}
.tpl-toolbar button:hover{border-color:var(--accent,#60a5fa)}
.tpl-toolbar button.danger{color:#e74c3c}
.tpl-toolbar button.danger:hover{border-color:#e74c3c}
.tpl-phase{background:var(--surface,#141414);border:1px solid var(--border,#333);border-radius:8px;margin-bottom:8px;overflow:hidden}
.tpl-phase-header{display:flex;align-items:center;padding:10px 12px;cursor:pointer;gap:8px;font-weight:600;font-size:13px}
.tpl-phase-header:hover{background:var(--surface2,#1e1e1e)}
.tpl-phase-header .arrow{transition:transform 0.2s;font-size:10px}
.tpl-phase-header .arrow.open{transform:rotate(90deg)}
.tpl-phase-body{display:none;padding:0 12px 12px}
.tpl-phase-body.open{display:block}
.tpl-pkg{margin:8px 0;padding:8px;background:var(--surface2,#1e1e1e);border-radius:6px;border:1px solid var(--border,#222)}
.tpl-pkg-header{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;margin-bottom:6px}
.tpl-task{display:grid;grid-template-columns:1fr 90px 70px 28px;gap:4px;align-items:center;padding:3px 0;font-size:12px;border-bottom:1px solid rgba(255,255,255,0.04)}
.tpl-task:last-child{border-bottom:none}
.tpl-task input,.tpl-task select{background:transparent;border:1px solid transparent;color:inherit;font-size:12px;padding:2px 4px;border-radius:4px}
.tpl-task input:hover,.tpl-task input:focus{border-color:var(--border,#333);background:var(--surface,#141414)}
.tpl-task input:focus{border-color:var(--accent,#60a5fa);outline:none}
.tpl-add-btn{font-size:11px;opacity:0.5;cursor:pointer;padding:2px 6px;border:1px dashed var(--border,#333);border-radius:4px;background:none;color:inherit;margin-top:4px}
.tpl-add-btn:hover{opacity:1;border-color:var(--accent,#60a5fa)}
.tpl-del{font-size:11px;cursor:pointer;opacity:0.3;color:#e74c3c;background:none;border:none;padding:2px}
.tpl-del:hover{opacity:1}
.tpl-name-input{font-size:16px;font-weight:700;background:transparent;border:1px solid transparent;color:inherit;padding:4px 8px;border-radius:6px;width:100%;max-width:400px}
.tpl-name-input:hover,.tpl-name-input:focus{border-color:var(--border,#333);background:var(--surface,#141414)}
.tpl-name-input:focus{border-color:var(--accent,#60a5fa);outline:none}
.templates-view{display:none}
.templates-view.active{display:block}
.pi-dash{padding:12px 0}
.pi-controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.pi-period{padding:6px 12px;border-radius:6px;border:1px solid var(--border,#333);background:var(--surface2,#1e1e1e);color:var(--txt,#eee);cursor:pointer;font-size:13px}
.pi-period.active{border-color:var(--accent,#60a5fa);background:rgba(96,165,250,.15)}
.pi-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:20px}
.pi-card{background:var(--surface2,#1e1e1e);border:1px solid var(--border,#333);border-radius:10px;padding:16px;text-align:center}
.pi-card h3{font-size:24px;margin:4px 0;color:var(--accent,#60a5fa)}
.pi-card small{font-size:11px;color:var(--dim,#888)}
.pi-section{margin-bottom:24px}
.pi-section h3{font-size:14px;margin-bottom:8px;color:var(--dim,#888);text-transform:uppercase;letter-spacing:1px}
.pi-table{width:100%;border-collapse:collapse;font-size:13px}
.pi-table th{text-align:left;padding:8px 10px;border-bottom:2px solid var(--border,#333);color:var(--dim,#888);font-weight:600}
.pi-table td{padding:8px 10px;border-bottom:1px solid var(--border,#222)}
.pi-table tr:hover td{background:rgba(255,255,255,.03)}
.pi-green{color:#4ade80} .pi-yellow{color:#fbbf24} .pi-red{color:#f87171}
.pi-bar{height:6px;border-radius:3px;background:var(--border,#333);overflow:hidden;min-width:60px}
.pi-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.pi-export-btn{padding:8px 16px;border-radius:8px;border:none;background:var(--accent,#60a5fa);color:#000;font-weight:600;cursor:pointer;font-size:13px}
.pi-empty{text-align:center;padding:40px;color:var(--dim,#888);font-size:14px}
.process-view{display:none} .process-view.active{display:block}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="sync-wrap" onclick="toggleActivityPanel()" style="position:fixed;bottom:12px;right:12px;z-index:9999"><div id="syncStatus" style="font-size:14px;padding:4px 10px;border-radius:8px;background:var(--surface2,#1e1e1e);border:1px solid var(--border,#333);cursor:pointer;opacity:0.7;transition:opacity 0.2s" onmouseenter="this.style.opacity=1" onmouseleave="this.style.opacity=0.7" title="Klick f√ºr Activity Feed"></div></div>
<div id="activityPanel" class="activity-panel">
  <div class="activity-panel-header"><h3>üìã Activity Feed</h3><button class="activity-panel-close" onclick="toggleActivityPanel()">‚úï</button></div>
  <div id="activityList" class="activity-list"><div class="activity-empty">Keine Aktivit√§ten</div></div>
</div>

<div class="app">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo" onclick="showDashboard()" style="cursor:pointer" title="Dashboard">
        <svg viewBox="0 0 26 26" fill="none"><rect width="26" height="26" rx="7" fill="var(--accent)"/><path d="M7 13l4 4 8-8" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div><h1>LaunchRamp</h1><span>by Digital Sun</span></div>
      </div>
      <button class="new-client-btn" onclick="addClient()">+ Neuer Kunde</button>
    </div>
    <div class="client-list" id="clientList"></div>
    <div class="sidebar-footer">LaunchRamp v5.0</div>
  </div>

  <div class="main-area">
    <!-- DASHBOARD -->
    <div class="dashboard" id="dashboardView"></div>

    <!-- CLIENT VIEW -->
    <div class="client-view" id="clientView">
    <div class="topbar">
      <div class="topbar-left">
        <span class="client-title" id="clientTitle" onclick="editTitle()"></span>
        <input class="client-title-input" id="clientTitleInput" onblur="saveTitle()" onkeydown="if(event.key==='Enter')saveTitle()">
        <div class="qlinks" id="qlinks"></div>
      </div>
      <div class="topbar-actions">
        <button class="btn" id="btnCV" onclick="toggleCV()">Kunden-Ansicht</button>
        <button class="btn primary" onclick="exportReport()">Report</button>
      </div>
    </div>

    <div class="timeline-bar">
      <label>Start:</label>
      <input type="date" id="startDate" onchange="setProjectStart(this.value)" title="Projekt-Startdatum">
      <div id="miniTimeline" style="flex:1;min-width:120px"></div>
      <label>Launch:</label>
      <input type="date" id="launchDate" onchange="A().launchDate=this.value;save();renderCountdown();renderMiniTimeline()">
      <span class="countdown" id="countdown"></span>
      <button class="btn sm" onclick="recalcDeadlines()" title="Deadlines automatisch berechnen">‚ö° Auto</button>
    </div>

    <div class="view-tabs">
      <div class="vtab active" onclick="setView('tasks',this)">Aufgaben</div>
      <div class="vtab" onclick="setView('docs',this)">Dokumente</div>
      <div class="vtab" onclick="setView('templates',this)">‚öôÔ∏è Templates</div>
<div class="vtab" onclick="setView('process',this)">üìä Analytics</div>
    </div>

    <div class="filters-bar" id="filtersBar">
      <span class="flabel">Owner</span>
      <button class="pill active" data-o="all" onclick="fOwner(this)">Alle</button>
      <button class="pill" data-o="Mitch" onclick="fOwner(this)">Mitch</button>
      <button class="pill" data-o="Max" onclick="fOwner(this)">Max</button>
      <button class="pill" data-o="Hussein" onclick="fOwner(this)">Hussein</button>
      <button class="pill" data-o="Tobie" onclick="fOwner(this)">Tobie</button>
      <span class="flabel" style="margin-left:8px">Status</span>
      <button class="pill active" data-s="all" onclick="fStatus(this)">Alle</button>
      <button class="pill" data-s="Offen" onclick="fStatus(this)">Offen</button>
      <button class="pill" data-s="In Arbeit" onclick="fStatus(this)">Aktiv</button>
      <button class="pill" data-s="Warte auf Kunde" onclick="fStatus(this)">Wartend</button>
      <button class="pill" data-s="Erledigt" onclick="fStatus(this)">Fertig</button>
      <input type="text" class="search-box" id="searchBox" placeholder="Suchen..." oninput="applyFilters()">
    </div>

    <div class="stats-row" id="statsRow">
      <div class="stat-card"><div class="stat-num" id="sT">0</div><div class="stat-label">Tasks</div></div>
      <div class="stat-card"><div class="stat-num" id="sD" style="color:var(--green)">0</div><div class="stat-label">Erledigt</div><div class="stat-sub" id="sDP"></div></div>
      <div class="stat-card"><div class="stat-num" id="sW" style="color:var(--yellow)">0</div><div class="stat-label">In Arbeit</div></div>
      <div class="stat-card"><div class="stat-num" id="sWa" style="color:var(--pink)">0</div><div class="stat-label">Wartend</div></div>
      <div class="stat-card"><div class="stat-num" id="sH">0h</div><div class="stat-label">Aufwand</div><div class="stat-sub" id="sHL"></div></div>
    </div>
    <div class="progress-track" id="progressBar"></div>

    <div class="content" id="content">
      <div class="tasks-view active" id="tasksView"></div>
      <div class="docs-view" id="docsView"></div>
    <div class="templates-view" id="templatesView"></div>
<div class="process-view" id="processView"></div>
    </div>
    </div><!-- /client-view -->
  </div>
</div>

<!-- MODALS -->
<div class="modal-bg" id="taskModal">
  <div class="modal">
    <h3 id="tmTitle">Aufgabe</h3>
    <div class="mf"><label>Aufgabe</label><input id="tmName"></div>
    <div class="mf-row">
      <div class="mf"><label>Owner</label><select id="tmOwner"><option>Mitch</option><option>Max</option><option>Hussein</option><option>Tobie</option><option>Team</option><option>Kunde</option></select></div>
      <div class="mf"><label>Aufwand (Min)</label><input type="number" id="tmMin" value="30" min="5" step="5"></div>
    </div>
    <div class="mf"><label>Voraussetzung</label><input id="tmVor" placeholder="Optional..."></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('taskModal')">Abbrechen</button>
      <button class="btn danger" id="tmDel" onclick="deleteTask()" style="display:none">L√∂schen</button>
      <button class="btn primary" onclick="saveTask()">Speichern</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="phaseModal">
  <div class="modal">
    <h3 id="pmTitle">Phase</h3>
    <div class="mf"><label>Name</label><input id="pmName" placeholder="z.B. Retention & Upsell"></div>
    <div class="mf"><label>Farbe</label><input type="color" id="pmColor" value="#6366f1"></div>
    <div class="mf-row">
      <div class="mf"><label>Startdatum</label><input type="date" id="pmStart"></div>
      <div class="mf"><label>Enddatum</label><input type="date" id="pmEnd"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('phaseModal')">Abbrechen</button>
      <button class="btn danger" id="pmDel" onclick="deletePhase()" style="display:none">L√∂schen</button>
      <button class="btn primary" onclick="savePhase()">Speichern</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="calModal">
  <div class="modal">
    <h3>Termin blocken</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:12px" id="calTask"></p>
    <div class="mf"><label>Datum</label><input type="date" id="calDate"></div>
    <div class="mf-row">
      <div class="mf"><label>Uhrzeit</label><input type="time" id="calTime" value="10:00"></div>
      <div class="mf"><label>Dauer (Min)</label><input type="number" id="calDur" min="15" step="15" value="60"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('calModal')">Abbrechen</button>
      <button class="btn primary" onclick="addToCal()">Google Calendar</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="linkModal">
  <div class="modal">
    <h3>Link bearbeiten</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:12px" id="linkName"></p>
    <div class="mf"><label>Google Drive URL</label><input type="url" id="linkUrl" placeholder="https://drive.google.com/..."></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('linkModal')">Abbrechen</button>
      <button class="btn danger" onclick="removeLink()">Entfernen</button>
      <button class="btn primary" onclick="saveLink()">Speichern</button>
    </div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div class="ctx-menu" id="ctxMenu">
  <div class="ctx-item" onclick="ctxEdit()">‚úèÔ∏è Bearbeiten</div>
  <div class="ctx-item" onclick="ctxDuplicate()">üìã Duplizieren</div>
  <div class="ctx-item" onclick="ctxCal()">üìÖ Termin blocken</div>
  <div class="ctx-item" onclick="ctxLogTime()">‚è± Zeit eintragen</div>
  <div class="ctx-item danger" onclick="ctxDelete()">üóëÔ∏è L√∂schen</div>
</div>

<div class="toast" id="toast"></div>

<script>

// ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPABASE_URL = 'https://pezpisgwkemvdclnhdsw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlenBpc2d3a2VtdmRjbG5oZHN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDE0MTAsImV4cCI6MjA4NzY3NzQxMH0.wzMrpKGri1ueWVOOhBYZPUxut8-s13vBrPpNUAywM9U';
let sbClient = null;
let isOnline = true;
let syncInProgress = false;
let lastRemoteUpdate = null;
let lastKnownRemote = null; // Baseline for conflict detection

// Initialize Supabase
try {
  sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('[LaunchRamp] Supabase connected');
} catch(e) {
  console.warn('[LaunchRamp] Supabase init failed, using localStorage only:', e);
  isOnline = false;
}

// ============================================================
// DATA
// ============================================================
function defaultPhases(){return JSON.parse(JSON.stringify([
{id:'P1',name:'PHASE 1: ONBOARDING & SETUP',color:'#2563eb',startDate:'',endDate:'',packages:[
{name:'Discovery & Vertr√§ge',tasks:[
{t:'Kennenlerngespr√§ch',owner:'Mitch',ki:true,vor:'Lead qualifiziert',auto:'Niedrig',min:45},
{t:'Roadmap/Proposal erstellen + pr√§sentieren',owner:'Mitch',ki:false,vor:'Kennenlerngespr√§ch',auto:'Hoch',min:60},
{t:'Strategiegespr√§ch (Deep Dive)',owner:'Mitch',ki:true,vor:'Proposal angenommen',auto:'Niedrig',min:90},
{t:'Vertrag + Rechnung + Payment',owner:'Mitch',ki:false,vor:'Zusage',auto:'Hoch',min:20},
]},
{name:'Technischer Kick-off',tasks:[
{t:'Internes Setup: Channels, Ordner, Board',owner:'Max',ki:false,vor:'Vertrag',auto:'Voll',min:15},
{t:'Zug√§nge erhalten (Domain, Hosting, Socials, Ads, Tools)',owner:'Max',ki:true,vor:'Kick-off',auto:'Mittel',min:30},
{t:'CI Assets erhalten + gepr√ºft',owner:'Hussein',ki:true,vor:'Kick-off',auto:'Mittel',min:20},
{t:'Bestehende Kan√§le + Analytics Audit',owner:'Max',ki:false,vor:'Zug√§nge',auto:'Mittel',min:30},
]}]},
{id:'P2',name:'PHASE 2: STRATEGIE & POSITIONIERUNG',color:'#059669',startDate:'',endDate:'',packages:[
{name:'Research & Analyse',tasks:[
{t:'Zielgruppen-Research (Interviews, Daten)',owner:'Mitch',ki:true,vor:'Strategiegespr√§ch',auto:'Hoch',min:120},
{t:'Wettbewerber-Analyse (3-5 Competitors)',owner:'Mitch',ki:false,vor:'Zielgruppe definiert',auto:'Hoch',min:60},
{t:'Markt-/Nischen-Analyse + Differenzierung',owner:'Mitch',ki:false,vor:'Research',auto:'Hoch',min:45},
]},
{name:'Positionierung & Angebot',tasks:[
{t:'Positionierung finalisieren (USP, Messaging)',owner:'Mitch',ki:true,vor:'Research',auto:'Hoch',min:60},
{t:'Angebot / Produkttreppe strukturieren',owner:'Mitch',ki:true,vor:'Positionierung',auto:'Hoch',min:60},
{t:'Pricing + Angebotsseite Konzept',owner:'Mitch',ki:false,vor:'Angebot',auto:'Hoch',min:30},
{t:'Positionierung + Angebot Kunden-Freigabe',owner:'Mitch',ki:true,vor:'Alles ready',auto:'Niedrig',min:30},
]}]},
{id:'P3',name:'PHASE 3: CLAUDE FIRST DRAFTS (BATCH)',color:'#d97706',startDate:'',endDate:'',packages:[
{name:'Landing Page & Angebotsseite',tasks:[
{t:'Landing Page Copy ‚Äì Claude First Draft',owner:'Mitch',ki:false,vor:'Positionierung + ICP',auto:'Hoch',min:45},
{t:'Angebotsseite Copy ‚Äì Claude First Draft',owner:'Mitch',ki:false,vor:'Produkttreppe',auto:'Hoch',min:45},
{t:'Thank-You-Page Copy ‚Äì Claude First Draft',owner:'Mitch',ki:false,vor:'LP-Konzept',auto:'Hoch',min:15},
]},
{name:'E-Mail & Automation',tasks:[
{t:'Willkommens-Sequenz (5-7 Mails) ‚Äì Claude Draft',owner:'Max',ki:false,vor:'Angebot + Tonalit√§t',auto:'Hoch',min:60},
{t:'Webinar-Reminder Mails ‚Äì Claude Draft',owner:'Max',ki:false,vor:'Webinar-Konzept',auto:'Hoch',min:30},
{t:'Follow-Up Sequenz ‚Äì Claude Draft',owner:'Max',ki:false,vor:'Webinar-Flow',auto:'Hoch',min:30},
{t:'WhatsApp Templates ‚Äì Claude Draft',owner:'Max',ki:false,vor:'Touchpoints',auto:'Hoch',min:15},
]},
{name:'Ads & Social Copy',tasks:[
{t:'Ad Copy Varianten (5-10 Hooks) ‚Äì Claude Draft',owner:'Mitch',ki:false,vor:'ICP + Positionierung',auto:'Hoch',min:45},
{t:'LinkedIn Posts (10-15) ‚Äì Claude Draft',owner:'Mitch',ki:false,vor:'Tonalit√§t + Themen',auto:'Hoch',min:60},
{t:'Social Media Captions ‚Äì Claude Draft',owner:'Tobie',ki:false,vor:'Content-Strategie',auto:'Hoch',min:30},
]},
{name:'VSL & Webinar',tasks:[
{t:'VSL Skript ‚Äì Claude Draft',owner:'Mitch',ki:false,vor:'Angebot + ICP',auto:'Hoch',min:45},
{t:'Webinar Outline ‚Äì Claude Draft',owner:'Mitch',ki:false,vor:'Konzept-Call',auto:'Hoch',min:30},
{t:'Umfrage Fragen ‚Äì Claude Draft',owner:'Mitch',ki:false,vor:'Zielgruppe',auto:'Hoch',min:15},
]}]},
{id:'P4',name:'PHASE 4: DESIGN & BUILD',color:'#dc2626',startDate:'',endDate:'',packages:[
{name:'Design',tasks:[
{t:'Landing Page Design (Mobile + Desktop)',owner:'Hussein',ki:false,vor:'LP Copy',auto:'Niedrig',min:240},
{t:'Angebotsseite Design',owner:'Hussein',ki:false,vor:'Copy',auto:'Niedrig',min:180},
{t:'Thank-You-Page Design',owner:'Hussein',ki:false,vor:'Copy',auto:'Niedrig',min:60},
{t:'E-Mail Template Design',owner:'Hussein',ki:false,vor:'CI',auto:'Mittel',min:120},
{t:'Ad Creatives (3-5 Varianten)',owner:'Hussein',ki:false,vor:'Ad Copy + CI',auto:'Niedrig',min:180},
{t:'Social Media Templates',owner:'Hussein',ki:false,vor:'Brand Guide',auto:'Mittel',min:120},
]},
{name:'Entwicklung',tasks:[
{t:'Landing Page entwickeln + testen',owner:'Max',ki:false,vor:'Design approved',auto:'Mittel',min:180},
{t:'Angebotsseite entwickeln',owner:'Max',ki:false,vor:'Design',auto:'Mittel',min:120},
{t:'Thank-You-Page entwickeln',owner:'Max',ki:false,vor:'Design',auto:'Mittel',min:45},
{t:'Formulare + Tracking einbauen',owner:'Max',ki:false,vor:'Pages',auto:'Mittel',min:60},
{t:'Cookie-Banner + Rechtliches',owner:'Max',ki:false,vor:'Domain',auto:'Mittel',min:30},
]},
{name:'Automationen',tasks:[
{t:'E-Mail Tool + Templates bauen',owner:'Max',ki:false,vor:'Designs',auto:'Mittel',min:90},
{t:'Automationsflows aufsetzen',owner:'Max',ki:false,vor:'Mails',auto:'Mittel',min:120},
{t:'CRM / Pipeline einrichten',owner:'Max',ki:false,vor:'Sales-Flow',auto:'Mittel',min:60},
{t:'Tracking Setup (Analytics, Pixel, UTM)',owner:'Max',ki:false,vor:'Pages + Ads',auto:'Mittel',min:60},
{t:'Kalender-Booking einrichten',owner:'Max',ki:false,vor:'CRM',auto:'Hoch',min:30},
]}]},
{id:'P5',name:'PHASE 5: WEBINAR & ADS',color:'#7c3aed',startDate:'',endDate:'',packages:[
{name:'Webinar',tasks:[
{t:'Webinar Skript komplett',owner:'Mitch',ki:false,vor:'Konzept-Call',auto:'Hoch',min:90},
{t:'Webinar Slides erstellen + designen',owner:'Hussein',ki:false,vor:'Skript',auto:'Mittel',min:225},
{t:'Slides Kunden-Freigabe',owner:'Mitch',ki:true,vor:'Slides',auto:'Niedrig',min:60},
{t:'Webinar-Tool + Technik einrichten',owner:'Max',ki:false,vor:'Tool-Zugang',auto:'Mittel',min:45},
{t:'Technik End-to-End testen',owner:'Max',ki:false,vor:'Setup',auto:'Manuell',min:30},
]},
{name:'Pitch-Training',tasks:[
{t:'Pitch-Training + Einwand-Handling',owner:'Mitch',ki:true,vor:'Slides final',auto:'Manuell',min:90},
{t:'Feedback einarbeiten',owner:'Mitch',ki:false,vor:'Training',auto:'Niedrig',min:30},
]},
{name:'Ads',tasks:[
{t:'Ad Accounts + Zielgruppen einrichten',owner:'Max',ki:false,vor:'Zug√§nge + ICP',auto:'Mittel',min:45},
{t:'Kampagnen aufsetzen',owner:'Max',ki:false,vor:'Creatives + Tracking',auto:'Mittel',min:60},
{t:'Kampagnen Kunden-Freigabe',owner:'Mitch',ki:true,vor:'Setup',auto:'Niedrig',min:20},
]}]},
{id:'P6',name:'PHASE 6: SOCIAL MEDIA',color:'#db2777',startDate:'',endDate:'',packages:[
{name:'Content-Strategie',tasks:[
{t:'Content-Strategie-Call',owner:'Mitch',ki:true,vor:'Positionierung',auto:'Niedrig',min:60},
{t:'Themen-Cluster + Kalender',owner:'Tobie',ki:false,vor:'Strategie-Call',auto:'Hoch',min:60},
]},
{name:'LinkedIn',tasks:[
{t:'LinkedIn Profil optimieren',owner:'Tobie',ki:true,vor:'Content-Strategie + CI',auto:'Mittel',min:60},
{t:'Posts finalisieren + planen',owner:'Tobie',ki:false,vor:'Posts freigegeben',auto:'Hoch',min:60},
{t:'LinkedIn Event + Banner',owner:'Tobie',ki:false,vor:'Webinar-Daten',auto:'Mittel',min:20},
]},
{name:'Instagram (Optional)',tasks:[
{t:'Instagram Profil optimieren',owner:'Tobie',ki:true,vor:'Content-Strategie',auto:'Mittel',min:30,opt:true},
{t:'Reels erstellen (5-7 Hooks)',owner:'Tobie',ki:true,vor:'Content-Strategie',auto:'Mittel',min:180,opt:true},
{t:'Carousel Posts (3 St√ºck)',owner:'Hussein',ki:false,vor:'CI',auto:'Mittel',min:90,opt:true},
]}]},
{id:'P7',name:'PHASE 7: LAUNCH',color:'#dc2626',startDate:'',endDate:'',packages:[
{name:'Pre-Launch',tasks:[
{t:'End-to-End Test aller Systeme',owner:'Max',ki:false,vor:'Alles aufgesetzt',auto:'Manuell',min:60},
{t:'Pages live schalten',owner:'Max',ki:false,vor:'E2E Test',auto:'Niedrig',min:15},
{t:'Generalprobe + GO/NO-GO',owner:'Mitch',ki:true,vor:'Technik ready',auto:'Manuell',min:120},
]},
{name:'Go-Live',tasks:[
{t:'Kampagnen aktivieren',owner:'Max',ki:false,vor:'Freigabe',auto:'Niedrig',min:15},
{t:'Performance Monitoring (Tag 1-3)',owner:'Max',ki:false,vor:'Kampagnen live',auto:'Mittel',min:15},
{t:'WEBINAR LIVE',owner:'Team',ki:false,vor:'Alles ready',auto:'Manuell',min:90},
{t:'Debrief-Call',owner:'Mitch',ki:true,vor:'Webinar',auto:'Manuell',min:30},
]},
{name:'After Sales',tasks:[
{t:'Replay + Follow-Up aktivieren',owner:'Max',ki:false,vor:'Webinar',auto:'Voll',min:15},
{t:'Sales Calls tracken + Coaching',owner:'Mitch',ki:true,vor:'Calls gebucht',auto:'Niedrig',min:60},
]}]},
{id:'P8',name:'PHASE 8: REVIEW & SCALE',color:'#6366f1',startDate:'',endDate:'',packages:[
{name:'Review',tasks:[
{t:'KPIs dokumentieren + Review-Call',owner:'Mitch',ki:true,vor:'Launch done',auto:'Mittel',min:60},
{t:'Learnings dokumentieren (Retro)',owner:'Team',ki:false,vor:'Review',auto:'Niedrig',min:30},
{t:'Testimonial + Case Study',owner:'Mitch',ki:true,vor:'Ergebnisse positiv',auto:'Hoch',min:30},
{t:'Weiterarbeit besprechen',owner:'Mitch',ki:true,vor:'Review',auto:'Manuell',min:30},
]}]}
]))}

const DOCS=[
  {id:'positionierung',icon:'üéØ',name:'Positionierung',desc:'USP, Messaging, Tonalit√§t',int:false},
  {id:'angebot',icon:'üíé',name:'Angebot',desc:'Offer + Pricing',int:false},
  {id:'zielgruppe',icon:'üë§',name:'Zielgruppe',desc:'ICP, Personas',int:false},
  {id:'ci',icon:'üé®',name:'CI / Brand',desc:'Logo, Farben, Fonts',int:false},
  {id:'roadmap',icon:'üó∫Ô∏è',name:'Roadmap',desc:'Kunden-Fahrplan',int:false},
  {id:'tracking',icon:'üìä',name:'Tracking',desc:'KPIs, Metriken',int:false},
  {id:'gdrive',icon:'üìÅ',name:'Google Drive',desc:'Alle Dateien',int:false},
  {id:'gchat',icon:'üí¨',name:'Google Chat',desc:'Team-Kommunikation',int:false},
  {id:'vault',icon:'üîê',name:'Vault',desc:'Passw√∂rter & Zug√§nge',int:false},
  {id:'claude',icon:'ü§ñ',name:'Claude Projekt',desc:'Chat & Transkripte',int:true},
  {id:'prompts',icon:'üìù',name:'Prompts',desc:'Prompt Library',int:true},
  {id:'sops',icon:'üé¨',name:'SOPs',desc:'Video-Anleitungen',int:true},
];

// ============================================================
// STATE
// ============================================================
let DB={clients:[],activeClient:null,activeProject:null};
let isCV=false, curView='tasks', fO='all', fS='all';
let dashboardActive=false;
// Track open/closed state for phases and packages
let openPhases=new Set();
let openPackages=new Set();
// Track expanded clients in sidebar
let expandedClients=new Set();

// Retainer categories
const RETAINER_CATEGORIES=[
  {id:'linkedin',name:'LinkedIn',icon:'üíº',phases:[{name:'LinkedIn Content',packages:[{name:'LinkedIn Management',tasks:[
    {t:'Content-Strategie & Themenplanung',owner:'Mitch',ki:true,vor:'-',auto:'Hoch',min:60},
    {t:'Posts schreiben (8-12/Monat)',owner:'Tobie',ki:false,vor:'Themenplan',auto:'Hoch',min:120},
    {t:'Profil-Optimierung & Updates',owner:'Tobie',ki:true,vor:'-',auto:'Mittel',min:30},
    {t:'Community Management & Engagement',owner:'Tobie',ki:false,vor:'Posts live',auto:'Mittel',min:60},
    {t:'Performance Report',owner:'Tobie',ki:false,vor:'Monatsende',auto:'Hoch',min:30}
  ]}]}]},
  {id:'instagram',name:'Instagram',icon:'üì∏',phases:[{name:'Instagram Content',packages:[{name:'Instagram Management',tasks:[
    {t:'Content-Strategie & Redaktionsplan',owner:'Tobie',ki:true,vor:'-',auto:'Hoch',min:60},
    {t:'Posts & Reels erstellen (8-12/Monat)',owner:'Tobie',ki:false,vor:'Redaktionsplan',auto:'Mittel',min:180},
    {t:'Stories & Community Management',owner:'Tobie',ki:false,vor:'Content live',auto:'Mittel',min:60},
    {t:'Performance Report',owner:'Tobie',ki:false,vor:'Monatsende',auto:'Hoch',min:30}
  ]}]}]},
  {id:'newsletter',name:'Newsletter',icon:'üìß',phases:[{name:'Newsletter',packages:[{name:'E-Mail Marketing',tasks:[
    {t:'Newsletter-Thema & Outline',owner:'Mitch',ki:true,vor:'-',auto:'Hoch',min:30},
    {t:'Newsletter schreiben (2-4/Monat)',owner:'Max',ki:false,vor:'Outline',auto:'Hoch',min:90},
    {t:'Design & Template',owner:'Hussein',ki:false,vor:'Text',auto:'Mittel',min:45},
    {t:'Versand & A/B-Test',owner:'Max',ki:false,vor:'Design',auto:'Mittel',min:20},
    {t:'Performance Report',owner:'Max',ki:false,vor:'Versand',auto:'Hoch',min:15}
  ]}]}]},
  {id:'blog',name:'Blog / SEO',icon:'‚úçÔ∏è',phases:[{name:'Blog & SEO',packages:[{name:'Content & SEO',tasks:[
    {t:'Keyword-Research & Themenplan',owner:'Mitch',ki:true,vor:'-',auto:'Hoch',min:60},
    {t:'Blog-Artikel schreiben (2-4/Monat)',owner:'Max',ki:false,vor:'Keywords',auto:'Hoch',min:120},
    {t:'On-Page SEO Optimierung',owner:'Max',ki:false,vor:'Artikel',auto:'Hoch',min:30},
    {t:'Interne Verlinkung & Updates',owner:'Max',ki:false,vor:'Artikel',auto:'Mittel',min:20},
    {t:'Ranking-Report',owner:'Max',ki:false,vor:'Monatsende',auto:'Hoch',min:15}
  ]}]}]},
  {id:'ads',name:'Ads Management',icon:'üì£',phases:[{name:'Ads',packages:[{name:'Paid Advertising',tasks:[
    {t:'Kampagnen-Review & Optimierung',owner:'Max',ki:false,vor:'-',auto:'Mittel',min:60},
    {t:'Neue Creatives & Copy',owner:'Hussein',ki:false,vor:'Performance-Daten',auto:'Mittel',min:90},
    {t:'Zielgruppen-Tests',owner:'Max',ki:false,vor:'Creatives',auto:'Mittel',min:30},
    {t:'Budget-Optimierung',owner:'Max',ki:false,vor:'Daten',auto:'Mittel',min:20},
    {t:'Performance Report + ROAS',owner:'Max',ki:false,vor:'Monatsende',auto:'Hoch',min:30}
  ]}]}]},
  {id:'seo',name:'Homepage SEO',icon:'üîç',phases:[{name:'SEO',packages:[{name:'SEO Optimierung',tasks:[
    {t:'Technisches SEO Audit',owner:'Max',ki:false,vor:'-',auto:'Hoch',min:60},
    {t:'Meta-Tags & Snippets optimieren',owner:'Max',ki:false,vor:'Audit',auto:'Hoch',min:45},
    {t:'Page Speed Optimierung',owner:'Max',ki:false,vor:'Audit',auto:'Mittel',min:60},
    {t:'Content-Gaps identifizieren',owner:'Mitch',ki:true,vor:'Audit',auto:'Hoch',min:30},
    {t:'Monatlicher SEO Report',owner:'Max',ki:false,vor:'Monatsende',auto:'Hoch',min:20}
  ]}]}]},
  {id:'youtube',name:'YouTube',icon:'üé¨',phases:[{name:'YouTube',packages:[{name:'YouTube Management',tasks:[
    {t:'Video-Strategie & Themenplan',owner:'Mitch',ki:true,vor:'-',auto:'Hoch',min:60},
    {t:'Skript schreiben (2-4/Monat)',owner:'Mitch',ki:false,vor:'Themenplan',auto:'Hoch',min:90},
    {t:'Video-Produktion & Editing',owner:'Hussein',ki:false,vor:'Skript',auto:'Niedrig',min:240},
    {t:'Thumbnail & SEO',owner:'Hussein',ki:false,vor:'Video',auto:'Mittel',min:30},
    {t:'Upload & Promotion',owner:'Tobie',ki:false,vor:'Video final',auto:'Mittel',min:20}
  ]}]}]},
  {id:'tiktok',name:'TikTok',icon:'üéµ',phases:[{name:'TikTok',packages:[{name:'TikTok Management',tasks:[
    {t:'Content-Strategie & Hooks',owner:'Tobie',ki:true,vor:'-',auto:'Hoch',min:45},
    {t:'Videos produzieren (8-15/Monat)',owner:'Tobie',ki:false,vor:'Strategie',auto:'Mittel',min:180},
    {t:'Posting & Hashtag-Strategie',owner:'Tobie',ki:false,vor:'Videos',auto:'Mittel',min:30},
    {t:'Trend-Monitoring & Reaktionen',owner:'Tobie',ki:false,vor:'-',auto:'Mittel',min:30},
    {t:'Performance Report',owner:'Tobie',ki:false,vor:'Monatsende',auto:'Hoch',min:15}
  ]}]}]},
  {id:'coaching',name:'Coaching & Beratung',icon:'üß†',phases:[{name:'Beratung',packages:[{name:'Coaching & Support',tasks:[
    {t:'Strategie-Call (monatlich)',owner:'Mitch',ki:true,vor:'-',auto:'Niedrig',min:60},
    {t:'Ad-hoc Beratung & Support',owner:'Mitch',ki:true,vor:'-',auto:'Niedrig',min:60},
    {t:'Monats-Review & Planung n√§chster Monat',owner:'Mitch',ki:true,vor:'Monatsende',auto:'Niedrig',min:45}
  ]}]}]}
];

function load(){
  // Phase 1: Load from localStorage for instant display
  try{DB=JSON.parse(localStorage.getItem('lr3')||'null')||{clients:[],activeClient:null,activeProject:null}}catch(e){DB={clients:[],activeClient:null,activeProject:null}}
  // Run all existing migrations (keep original migration logic)
  if(DB.clients.length&&!DB.clients[0].projects){
    DB.clients.forEach(c=>{
      const proj={id:'p'+Date.now()+'_'+Math.random().toString(36).substr(2,4),name:c.name+' Launch',type:'launch',
      phases:c.phases||[],states:c.states||{},docLinks:c.docLinks||{},jfNotes:c.jfNotes||'',
      quickLinks:c.quickLinks||{homepage:'',instagram:'',linkedin:'',gdrive:'',claude:''},
      timeLog:c.timeLog||[],activeTimer:c.activeTimer||null,
      startDate:c.startDate||new Date().toISOString().split('T')[0],launchDate:c.launchDate||futDate(60),
      completed:false};
      c.projects=[proj];
      delete c.phases;delete c.states;delete c.docLinks;delete c.jfNotes;
      delete c.quickLinks;delete c.timeLog;delete c.activeTimer;
      delete c.startDate;delete c.launchDate;
    });
    if(DB.activeClient){const ac=DB.clients.find(c=>c.id===DB.activeClient);if(ac&&ac.projects.length)DB.activeProject=ac.projects[0].id;}
    save();
  }
  if(!DB.activeProject)DB.activeProject=null;
  if(!DB.clients.length){const c=mkClientWithProject('Beispiel-Kunde','launch');DB.clients.push(c);DB.activeClient=c.id;DB.activeProject=c.projects[0].id;}
  DB.clients.forEach(c=>{
    if(!c.projects)c.projects=[];
    c.projects.forEach(proj=>{
      if(!proj.startDate)proj.startDate=proj.phases[0]?.startDate||new Date().toISOString().split('T')[0];
      if(!proj.quickLinks)proj.quickLinks={homepage:'',instagram:'',linkedin:'',gdrive:'',claude:''};
      if(!proj.jourfix&&proj.docLinks&&proj.docLinks['jourfix']){proj.jourfix={day:3,time:'15:00',meetLink:proj.docLinks['jourfix']};delete proj.docLinks['jourfix']}
      if(!proj.jourfix)proj.jourfix={};
      if(!proj.timeLog)proj.timeLog=[];
      if(!proj.activeTimer)proj.activeTimer=null;
      if(proj.completed===undefined)proj.completed=false;
      proj.phases.forEach(p=>{if(!p.startDate)p.startDate='';if(!p.endDate)p.endDate=''});
    });
  });
  if(DB.activeClient)expandedClients.add(DB.activeClient);
  // Phase 2: Async load from Supabase (overrides localStorage if newer)
  loadFromSupabase();
}
function save(){localStorage.setItem('lr3',JSON.stringify(DB));saveToSupabase()}


// ============================================================
// SUPABASE SYNC FUNCTIONS (with Field-Level Merge)
// ============================================================

// ---------- MERGE UTILITIES ----------
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

function mergeStates(localStates, remoteStates, baseStates){
  // Merge task states key-by-key. Both local and remote changes win over base.
  // If both changed same key differently, remote wins.
  const merged = Object.assign({}, baseStates);
  // Apply remote changes
  Object.keys(remoteStates).forEach(k => { merged[k] = remoteStates[k]; });
  // Apply local changes (only if local changed from base AND remote didn't also change it)
  Object.keys(localStates).forEach(k => {
    const localChanged = localStates[k] !== (baseStates[k] || '');
    const remoteChanged = remoteStates[k] !== (baseStates[k] || '');
    if(localChanged && !remoteChanged) merged[k] = localStates[k];
    // If both changed: remote already wins from above
  });
  return merged;
}

function mergeClients(localClients, remoteClients, baseClients){
  // Build maps by client ID
  const baseMap = {};  (baseClients||[]).forEach(c => baseMap[c.id] = c);
  const localMap = {}; (localClients||[]).forEach(c => localMap[c.id] = c);
  const remoteMap = {};(remoteClients||[]).forEach(c => remoteMap[c.id] = c);
  const allIds = new Set([...Object.keys(localMap), ...Object.keys(remoteMap)]);
  const merged = [];

  allIds.forEach(id => {
    const base = baseMap[id];
    const local = localMap[id];
    const remote = remoteMap[id];

    if(!local && remote && base){
      // Local deleted this client, remote still has it -> respect local delete
      return;
    }
    if(local && !remote && base){
      // Remote deleted this client -> respect remote delete
      return;
    }
    if(local && !remote && !base){
      // New local client -> keep
      merged.push(deepClone(local));
      return;
    }
    if(!local && remote && !base){
      // New remote client -> keep
      merged.push(deepClone(remote));
      return;
    }
    if(!local && !remote) return;

    // Both have this client -> merge projects
    const mergedClient = deepClone(remote || local);
    if(local && remote){
      mergedClient.projects = mergeProjects(
        local.projects || [],
        remote.projects || [],
        base ? base.projects || [] : []
      );
      // Keep remote name if changed, else local
      if(base && local.name !== base.name && remote.name === base.name) mergedClient.name = local.name;
    }
    merged.push(mergedClient);
  });

  return merged;
}

function mergeProjects(localProjects, remoteProjects, baseProjects){
  const baseMap = {};  (baseProjects||[]).forEach(p => baseMap[p.id] = p);
  const localMap = {}; (localProjects||[]).forEach(p => localMap[p.id] = p);
  const remoteMap = {};(remoteProjects||[]).forEach(p => remoteMap[p.id] = p);
  const allIds = new Set([...Object.keys(localMap), ...Object.keys(remoteMap)]);
  const merged = [];

  allIds.forEach(id => {
    const base = baseMap[id];
    const local = localMap[id];
    const remote = remoteMap[id];

    if(!local && remote && base) return; // local deleted
    if(local && !remote && base) return; // remote deleted
    if(local && !remote && !base){ merged.push(deepClone(local)); return; } // new local
    if(!local && remote && !base){ merged.push(deepClone(remote)); return; } // new remote
    if(!local && !remote) return;

    // Both have project -> merge states and timeLog
    const mergedProj = deepClone(remote);
    if(local && remote && base){
      // Merge states (most important!)
      mergedProj.states = mergeStates(local.states||{}, remote.states||{}, base.states||{});
      // Merge timeLog (append unique entries)
      const remoteLogSet = new Set((remote.timeLog||[]).map(e => e.start));
      const baseLogSet = new Set((base.timeLog||[]).map(e => e.start));
      (local.timeLog||[]).forEach(entry => {
        if(!remoteLogSet.has(entry.start) && !baseLogSet.has(entry.start)){
          mergedProj.timeLog.push(entry); // new local entry
        }
      });
      // Merge quickLinks
      if(local.quickLinks && base.quickLinks){
        Object.keys(local.quickLinks).forEach(k => {
          if(local.quickLinks[k] !== (base.quickLinks[k]||'') && remote.quickLinks[k] === (base.quickLinks[k]||'')){
            mergedProj.quickLinks[k] = local.quickLinks[k];
          }
        });
      }
      // Merge docLinks
      if(local.docLinks && base.docLinks){
        Object.keys(local.docLinks).forEach(k => {
          if(local.docLinks[k] !== (base.docLinks[k]||'') && (remote.docLinks||{})[k] === (base.docLinks[k]||'')){
            if(!mergedProj.docLinks) mergedProj.docLinks = {};
            mergedProj.docLinks[k] = local.docLinks[k];
          }
        });
      }
      // Keep local project name if locally changed
      if(local.name !== base.name && remote.name === base.name) mergedProj.name = local.name;
      // Keep local dates if locally changed
      if(local.startDate !== base.startDate && remote.startDate === base.startDate) mergedProj.startDate = local.startDate;
      if(local.launchDate !== base.launchDate && remote.launchDate === base.launchDate) mergedProj.launchDate = local.launchDate;
      // Keep local completed if locally changed
      if(local.completed !== base.completed && remote.completed === base.completed) mergedProj.completed = local.completed;
    } else if(local && remote){
      // No base - remote wins but keep local states
      mergedProj.states = Object.assign({}, remote.states||{}, local.states||{});
    }
    merged.push(mergedProj);
  });

  return merged;
}

// ---------- LOAD FROM SUPABASE ----------
async function loadFromSupabase(){
  if(!sbClient){updateSyncStatus('offline');return}
  try{
    const{data,error}=await sbClient.from('app_state').select('data,updated_at').eq('id','main').single();
    if(error){console.warn('[Supabase] Load error:',error);updateSyncStatus('error');return}
    if(data&&data.data&&data.data.clients&&data.data.clients.length>0){
      const remoteStr=JSON.stringify(data.data);
      const localStr=JSON.stringify({clients:DB.clients,activeClient:DB.activeClient,activeProject:DB.activeProject});
      if(remoteStr!==localStr){
        console.log('[Supabase] Remote data loaded, updating local');
        lastRemoteUpdate=data.updated_at;
        DB.clients=data.data.clients||[];
        DB.activeClient=data.data.activeClient||null;
        DB.activeProject=data.data.activeProject||null;
        // Run migrations
        DB.clients.forEach(c=>{
          if(!c.projects)c.projects=[];
          c.projects.forEach(proj=>{
            if(!proj.startDate)proj.startDate=proj.phases[0]?.startDate||new Date().toISOString().split('T')[0];
            if(!proj.quickLinks)proj.quickLinks={homepage:'',instagram:'',linkedin:'',gdrive:'',claude:''};
            if(!proj.jourfix)proj.jourfix={};
            if(!proj.timeLog)proj.timeLog=[];
            if(!proj.activeTimer)proj.activeTimer=null;
            if(proj.completed===undefined)proj.completed=false;
            proj.phases.forEach(p=>{if(!p.startDate)p.startDate='';if(!p.endDate)p.endDate=''});
          });
        });
        if(!DB.clients.length){const c=mkClientWithProject('Beispiel-Kunde','launch');DB.clients.push(c);DB.activeClient=c.id;DB.activeProject=c.projects[0].id;}
        localStorage.setItem('lr3',JSON.stringify(DB));
        if(DB.activeClient)expandedClients.add(DB.activeClient);
        renderAll();
      }
      // Store baseline for future merge
      lastKnownRemote = deepClone({clients:DB.clients,activeClient:DB.activeClient,activeProject:DB.activeProject});
    } else if(DB.clients.length>0){
      console.log('[Supabase] Remote empty, pushing local data');
      lastKnownRemote = deepClone({clients:DB.clients,activeClient:DB.activeClient,activeProject:DB.activeProject});
      await saveToSupabaseDirect();
    }
    isOnline=true;
    updateSyncStatus('synced');
    setupRealtimeSubscription();
    setupActivitySubscription();
    ensureActor();
  }catch(e){console.warn('[Supabase] Load failed:',e);updateSyncStatus('error')}
}

// ---------- SAVE TO SUPABASE (with merge) ----------
let saveTimeout=null;
function saveToSupabase(){
  if(!sbClient||syncInProgress)return;
  clearTimeout(saveTimeout);
  saveTimeout=setTimeout(async()=>{
    syncInProgress=true;
    updateSyncStatus('syncing');
    try{
      const localPayload={clients:DB.clients,activeClient:DB.activeClient,activeProject:DB.activeProject};

      if(lastKnownRemote){
        // Fetch current remote state
        const{data:currentRemote,error:fetchErr}=await sbClient.from('app_state').select('data').eq('id','main').single();
        if(!fetchErr && currentRemote && currentRemote.data){
          const remoteStr=JSON.stringify(currentRemote.data);
          const baseStr=JSON.stringify(lastKnownRemote);
          if(remoteStr!==baseStr){
            // Remote changed since we last loaded -> MERGE
            console.log('[Supabase] Conflict detected, merging...');
            const mergedClients = mergeClients(localPayload.clients, currentRemote.data.clients||[], lastKnownRemote.clients||[]);
            localPayload.clients = mergedClients;
            // Update local DB with merged data
            DB.clients = mergedClients;
            localStorage.setItem('lr3',JSON.stringify(DB));
            renderAll();
            toast('Merge: Deine und Remote-Aenderungen zusammengefuehrt');
          }
        }
      }

      // Now save the (possibly merged) payload
      const{error}=await sbClient.from('app_state').update({data:localPayload,updated_by:navigator.userAgent.substring(0,50)}).eq('id','main');
      if(error){console.warn('[Supabase] Save error:',error);updateSyncStatus('error')}
      else{
        console.log('[Supabase] Saved');
        updateSyncStatus('synced');
        lastRemoteUpdate=new Date().toISOString();
        lastKnownRemote=deepClone(localPayload);
      }
    }catch(e){console.warn('[Supabase] Save failed:',e);updateSyncStatus('error')}
    syncInProgress=false;
  },500);
}

// Direct save without merge (for initial push)
async function saveToSupabaseDirect(){
  if(!sbClient)return;
  const payload={clients:DB.clients,activeClient:DB.activeClient,activeProject:DB.activeProject};
  await sbClient.from('app_state').upsert({id:'main',data:payload,updated_by:navigator.userAgent.substring(0,50)});
  lastKnownRemote=deepClone(payload);
}

// ===== M3: ACTIVITY FEED =====
let actUser = localStorage.getItem("lr3_user");
let actCount = 0;
let actItems = [];
let actPanelOpen = false;
let actAutoCloseTimer = null;

function ensureActor(){
  if(!actUser){
    const name = prompt("Wer bist du? (Name f√ºr Activity Feed)");
    if(name && name.trim()){ actUser = name.trim(); localStorage.setItem("lr3_user", actUser); }
    else { actUser = "Anonym"; localStorage.setItem("lr3_user", actUser); }
  }
  return actUser;
}

async function logActivity(action, detail){
  const actor = ensureActor();
  const payload = { action, detail: detail || {}, actor, created_at: new Date().toISOString() };
  try {
    const r = await fetch(SUPABASE_URL + "/rest/v1/activity_log", {
      method: "POST", headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": "Bearer " + SUPABASE_ANON_KEY, "Content-Type": "application/json", "Prefer": "return=minimal" },
      body: JSON.stringify(payload)
    });
    if(!r.ok) console.warn("Activity log failed:", r.status);
  } catch(e){ console.warn("Activity log error:", e); }
}

function toggleActivityPanel(){
  actPanelOpen = !actPanelOpen;
  const panel = document.getElementById("activityPanel");
  if(panel){ panel.classList.toggle("open", actPanelOpen); }
  if(actPanelOpen){
    actCount = 0; updateActBadge();
    loadActivities();
    if(actAutoCloseTimer) clearTimeout(actAutoCloseTimer);
    actAutoCloseTimer = setTimeout(function(){ if(actPanelOpen){ toggleActivityPanel(); } }, 10000);
  } else {
    if(actAutoCloseTimer){ clearTimeout(actAutoCloseTimer); actAutoCloseTimer = null; }
  }
}

function updateActBadge(){
  const wrap = document.querySelector(".sync-wrap");
  if(!wrap) return;
  let badge = document.getElementById("actBadge");
  if(!badge){ badge=document.createElement("span"); badge.id="actBadge"; badge.className="activity-badge"; wrap.appendChild(badge); }
  if(actCount > 0){ badge.style.display="flex"; badge.textContent=actCount>9?"9+":actCount; }
  else { badge.style.display="none"; }
}

async function loadActivities(){
  try {
    const r = await fetch(SUPABASE_URL + "/rest/v1/activity_log?order=created_at.desc&limit=30", {
      headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": "Bearer " + SUPABASE_ANON_KEY }
    });
    if(r.ok){ actItems = await r.json(); renderActivityList(); }
  } catch(e){ console.warn("Load activities error:", e); }
}

function renderActivityList(){
  const list = document.getElementById("activityList");
  if(!list) return;
  if(!actItems.length){ list.innerHTML = '<div class="activity-empty">Keine Aktivit√§ten bisher</div>'; return; }
  list.innerHTML = actItems.map(function(it){
    const d = new Date(it.created_at);
    const time = d.toLocaleDateString("de-CH",{day:"2-digit",month:"2-digit"}) + " " + d.toLocaleTimeString("de-CH",{hour:"2-digit",minute:"2-digit"});
    const det = it.detail || {};
    let desc = it.action;
    if(it.action === "status_change") desc = "Status: " + (det.task||"?") + " ‚Üí " + (det.newStatus||"?");
    else if(it.action === "timer_start") desc = "Timer gestartet: " + (det.task||"?");
    else if(it.action === "timer_stop") desc = "Timer gestoppt: " + (det.task||"?") + " (" + (det.duration||"?") + ")";
    else if(it.action === "project_created") desc = "Neues Projekt: " + (det.name||"?");
    else if(it.action === "client_created") desc = "Neuer Kunde: " + (det.name||"?");
    else if(it.action === "doc_linked") desc = "Dokument verlinkt: " + (det.name||"?");
    return '<div class="activity-item"><div class="act-time">' + time + '</div><span class="act-actor">' + (it.actor||"?") + '</span> <span class="act-action">' + desc + '</span></div>';
  }).join("");
}

function setupActivitySubscription(){
  if(!sbClient) return;
  sbClient.channel("activity-feed").on("postgres_changes",{event:"INSERT",schema:"public",table:"activity_log"},function(payload){
    const newItem = payload.new;
    if(newItem.actor !== actUser){
      actCount++;
      updateActBadge();
    }
    actItems.unshift(newItem);
    if(actItems.length > 30) actItems.pop();
    if(actPanelOpen) renderActivityList();
  }).subscribe();
}
// ===== END M3: ACTIVITY FEED =====

// ============================================================
// M4: TEMPLATE SETTINGS PANEL
// ============================================================
let tplCache = null;
let tplActive = null;

async function loadTemplates(){
  try{
    const r=await fetch(SUPABASE_URL+"/rest/v1/templates?select=*&order=type,name",{
      headers:{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY}
    });
    if(r.ok){ tplCache=await r.json(); }
    else{ console.warn("loadTemplates error",r.status); tplCache=[]; }
  }catch(e){ console.warn("loadTemplates fetch error",e); tplCache=[]; }
  return tplCache;
}

async function saveTemplate(tpl){
  tpl.updated_at=new Date().toISOString();
  const r=await fetch(SUPABASE_URL+"/rest/v1/templates?id=eq."+encodeURIComponent(tpl.id),{
    method:"PATCH",
    headers:{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY,"Content-Type":"application/json","Prefer":"return=minimal"},
    body:JSON.stringify({name:tpl.name,data:tpl.data,updated_at:tpl.updated_at})
  });
  if(!r.ok) console.warn("saveTemplate error",r.status);
  else logActivity("template_edit",{template:tpl.name});
}

async function createTemplate(name,type){
  const id=type+"_"+Date.now();
  const tpl={id,name,type,data:{phases:[]},created_at:new Date().toISOString(),updated_at:new Date().toISOString(),created_by:actUser||"Anonym"};
  const r=await fetch(SUPABASE_URL+"/rest/v1/templates",{
    method:"POST",
    headers:{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY,"Content-Type":"application/json","Prefer":"return=minimal"},
    body:JSON.stringify(tpl)
  });
  if(r.ok){
    tplCache.push(tpl);
    tplActive=tpl.id;
    logActivity("template_create",{template:name});
    renderTemplates();
  }
}

async function duplicateTemplate(srcId){
  const src=tplCache.find(t=>t.id===srcId);
  if(!src) return;
  const name=prompt("Name f√ºr die Kopie:",src.name+" (Kopie)");
  if(!name) return;
  const id=src.type+"_"+Date.now();
  const tpl={id,name,type:src.type,data:JSON.parse(JSON.stringify(src.data)),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),created_by:actUser||"Anonym"};
  const r=await fetch(SUPABASE_URL+"/rest/v1/templates",{
    method:"POST",
    headers:{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY,"Content-Type":"application/json","Prefer":"return=minimal"},
    body:JSON.stringify(tpl)
  });
  if(r.ok){
    tplCache.push(tpl);
    tplActive=tpl.id;
    logActivity("template_duplicate",{source:src.name,newName:name});
    renderTemplates();
  }
}

async function deleteTemplate(id){
  const tpl=tplCache.find(t=>t.id===id);
  if(!tpl||!confirm("Template \""+tpl.name+"\" wirklich l√∂schen?")) return;
  await fetch(SUPABASE_URL+"/rest/v1/templates?id=eq."+encodeURIComponent(id),{
    method:"DELETE",
    headers:{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY}
  });
  tplCache=tplCache.filter(t=>t.id!==id);
  if(tplActive===id) tplActive=null;
  logActivity("template_delete",{template:tpl.name});
  renderTemplates();
}

async function renderTemplates(){
  if(!tplCache) await loadTemplates();
  const el=document.getElementById("templatesView");
  if(!el) return;
  // If no templates yet, migrate defaults
  if(tplCache.length===0){ await migrateDefaultTemplates(); }
  let h="<div style=\"padding:8px\">";
  h+="<div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px\">";
  h+="<h3 style=\"margin:0;font-size:16px\">üìã Template-Verwaltung</h3>";
  h+="<button class=\"tpl-add-btn\" onclick=\"newTemplateDialog()\" style=\"font-size:13px;padding:6px 14px\">Ôºã Neues Template</button>";
  h+="</div>";
  // Template cards grid
  h+="<div class=\"tpl-grid\">";
  const types={launch:"üöÄ Launch",retainer_category:"üîÑ Retainer",webinar:"üì∫ Webinar",custom:"‚ö° Custom"};
  for(const tpl of tplCache){
    const phases=tpl.data&&tpl.data.phases?tpl.data.phases:[];
    const taskCount=phases.reduce((s,p)=>s+(p.packages||[]).reduce((s2,pk)=>s2+(pk.tasks||[]).length,0),0);
    const isActive=tplActive===tpl.id;
    h+="<div class=\"tpl-card"+(isActive?" active":"")+"\" onclick=\"tplActive='"+tpl.id+"';renderTemplates()\">";
    h+="<h4>"+esc(tpl.name)+"</h4>";
    h+="<div class=\"tpl-type\">"+(types[tpl.type]||tpl.type)+"</div>";
    h+="<div class=\"tpl-stats\">"+phases.length+" Phasen ¬∑ "+taskCount+" Tasks</div>";
    h+="</div>";
  }
  h+="</div>";
  // If a template is active, show editor
  if(tplActive){
    const tpl=tplCache.find(t=>t.id===tplActive);
    if(tpl) h+=renderTemplateEditor(tpl);
  }
  h+="</div>";
  el.innerHTML=h;
}

function renderTemplateEditor(tpl){
  let h="<div class=\"tpl-editor\">";
  h+="<div class=\"tpl-toolbar\">";
  h+="<input class=\"tpl-name-input\" value=\""+esc(tpl.name)+"\" onchange=\"tplRename('"+tpl.id+"',this.value)\" />";
  h+="<button onclick=\"duplicateTemplate('"+tpl.id+"')\" title=\"Duplizieren\">üìã Duplizieren</button>";
  h+="<button onclick=\"tplAddPhase('"+tpl.id+"')\" title=\"Phase hinzuf√ºgen\">Ôºã Phase</button>";
  h+="<button class=\"danger\" onclick=\"deleteTemplate('"+tpl.id+"')\" title=\"L√∂schen\">üóë L√∂schen</button>";
  h+="</div>";
  const phases=tpl.data&&tpl.data.phases?tpl.data.phases:[];
  for(let pi=0;pi<phases.length;pi++){
    const ph=phases[pi];
    h+="<div class=\"tpl-phase\">";
    h+="<div class=\"tpl-phase-header\" onclick=\"tplTogglePhase(this)\">";
    h+="<span class=\"arrow\">‚ñ∂</span>";
    h+="<input value=\""+esc(ph.name||ph.phase||"")+"\" onclick=\"event.stopPropagation()\" onchange=\"tplEditPhase('"+tpl.id+"',"+pi+",this.value)\" style=\"flex:1;background:transparent;border:1px solid transparent;color:inherit;font-weight:600;font-size:13px;padding:2px 4px;border-radius:4px\" />";
    h+="<button class=\"tpl-del\" onclick=\"event.stopPropagation();tplDelPhase('"+tpl.id+"',"+pi+")\" title=\"Phase l√∂schen\">‚úï</button>";
    h+="</div>";
    h+="<div class=\"tpl-phase-body\">";
    const pkgs=ph.packages||[];
    for(let ki=0;ki<pkgs.length;ki++){
      const pk=pkgs[ki];
      h+="<div class=\"tpl-pkg\">";
      h+="<div class=\"tpl-pkg-header\">";
      h+="<input value=\""+esc(pk.name||pk.package||"")+"\" onchange=\"tplEditPkg('"+tpl.id+"',"+pi+","+ki+",this.value)\" style=\"flex:1;background:transparent;border:1px solid transparent;color:inherit;font-weight:600;font-size:12px;padding:2px 4px;border-radius:4px\" />";
      h+="<button class=\"tpl-del\" onclick=\"tplDelPkg('"+tpl.id+"',"+pi+","+ki+")\" title=\"Package l√∂schen\">‚úï</button>";
      h+="</div>";
      const tasks=pk.tasks||[];
      for(let ti=0;ti<tasks.length;ti++){
        const tk=tasks[ti];
        h+="<div class=\"tpl-task\">";
        h+="<input value=\""+esc(tk.t||tk.name||tk.task||"")+"\" onchange=\"tplEditTask('"+tpl.id+"',"+pi+","+ki+","+ti+",'name',this.value)\" placeholder=\"Task-Name\" />";
        h+="<input value=\""+esc(tk.owner||"")+"\" onchange=\"tplEditTask('"+tpl.id+"',"+pi+","+ki+","+ti+",'owner',this.value)\" placeholder=\"Owner\" style=\"text-align:center\" />";
        h+="<input type=\"number\" value=\""+(tk.min||tk.planzeit||tk.plan||0)+"\" onchange=\"tplEditTask('"+tpl.id+"',"+pi+","+ki+","+ti+",'planzeit',+this.value)\" style=\"text-align:center\" title=\"Planzeit (min)\" />";
        h+="<button class=\"tpl-del\" onclick=\"tplDelTask('"+tpl.id+"',"+pi+","+ki+","+ti+")\" title=\"Task l√∂schen\">‚úï</button>";
        h+="</div>";
      }
      h+="<button class=\"tpl-add-btn\" onclick=\"tplAddTask('"+tpl.id+"',"+pi+","+ki+")\" >Ôºã Task</button>";
      h+="</div>";
    }
    h+="<button class=\"tpl-add-btn\" onclick=\"tplAddPkg('"+tpl.id+"',"+pi+")\" style=\"margin-top:4px\">Ôºã Package</button>";
    h+="</div></div>";
  }
  h+="</div>";
  return h;
}

function tplTogglePhase(el){
  const arrow=el.querySelector(".arrow");
  const body=el.nextElementSibling;
  if(body){ body.classList.toggle("open"); }
  if(arrow){ arrow.classList.toggle("open"); }
}

function tplGetTpl(id){ return tplCache.find(t=>t.id===id); }

function tplRename(id,val){
  const t=tplGetTpl(id); if(!t) return;
  t.name=val; saveTemplate(t);
}

function tplEditPhase(id,pi,val){
  const t=tplGetTpl(id); if(!t) return;
  t.data.phases[pi].name=val; t.data.phases[pi].phase=val;
  saveTemplate(t);
}

function tplEditPkg(id,pi,ki,val){
  const t=tplGetTpl(id); if(!t) return;
  t.data.phases[pi].packages[ki].name=val; t.data.phases[pi].packages[ki].package=val;
  saveTemplate(t);
}

function tplEditTask(id,pi,ki,ti,field,val){
  const t=tplGetTpl(id); if(!t) return;
  const tk=t.data.phases[pi].packages[ki].tasks[ti];
  if(field==="name"){ tk.t=val; tk.name=val; tk.task=val; }
  else if(field==="owner"){ tk.owner=val; }
  else if(field==="planzeit"){ tk.min=val; tk.planzeit=val; tk.plan=val; }
  saveTemplate(t);
}

function tplAddPhase(id){
  const t=tplGetTpl(id); if(!t) return;
  if(!t.data.phases) t.data.phases=[];
  t.data.phases.push({name:"Neue Phase",phase:"Neue Phase",packages:[]});
  saveTemplate(t); renderTemplates();
}

function tplAddPkg(id,pi){
  const t=tplGetTpl(id); if(!t) return;
  if(!t.data.phases[pi].packages) t.data.phases[pi].packages=[];
  t.data.phases[pi].packages.push({name:"Neues Package",package:"Neues Package",tasks:[]});
  saveTemplate(t); renderTemplates();
}

function tplAddTask(id,pi,ki){
  const t=tplGetTpl(id); if(!t) return;
  if(!t.data.phases[pi].packages[ki].tasks) t.data.phases[pi].packages[ki].tasks=[];
  t.data.phases[pi].packages[ki].tasks.push({t:"Neuer Task",name:"Neuer Task",task:"Neuer Task",owner:"",min:0,planzeit:0,plan:0});
  saveTemplate(t); renderTemplates();
}

function tplDelPhase(id,pi){
  const t=tplGetTpl(id); if(!t) return;
  if(!confirm("Phase \""+t.data.phases[pi].name+"\" l√∂schen?")) return;
  t.data.phases.splice(pi,1);
  saveTemplate(t); renderTemplates();
}

function tplDelPkg(id,pi,ki){
  const t=tplGetTpl(id); if(!t) return;
  t.data.phases[pi].packages.splice(ki,1);
  saveTemplate(t); renderTemplates();
}

function tplDelTask(id,pi,ki,ti){
  const t=tplGetTpl(id); if(!t) return;
  t.data.phases[pi].packages[ki].tasks.splice(ti,1);
  saveTemplate(t); renderTemplates();
}

function newTemplateDialog(){
  const name=prompt("Template-Name:");
  if(!name) return;
  const type=prompt("Typ (launch/retainer_category/webinar/custom):","custom");
  if(!type) return;
  createTemplate(name,type);
}

async function migrateDefaultTemplates(){
  // Migrate hardcoded defaultPhases into Supabase template
  const defData=defaultPhases();
  // Convert to template format: phases[{name,packages:[{name,tasks:[{name,owner,planzeit}]}]}]
  const launchPhases=defData.map(p=>({
    name:p.name||p.phase||"",
    phase:p.name||p.phase||"",
    packages:(p.packages||[]).map(pk=>({
      name:pk.name||pk.package||"",
      package:pk.name||pk.package||"",
      tasks:(pk.tasks||[]).map(tk=>({
        name:tk.t||tk.task||tk.name||"",
        task:tk.t||tk.task||tk.name||"",
        owner:tk.owner||"",
        planzeit:tk.min||tk.planzeit||tk.plan||0,
        plan:tk.min||tk.planzeit||tk.plan||0
      }))
    }))
  }));
  const launchTpl={id:"launch_default",name:"Launch (Standard)",type:"launch",data:{phases:launchPhases},created_at:new Date().toISOString(),updated_at:new Date().toISOString(),created_by:"System"};
  // Migrate RETAINER_CATEGORIES
  const templates=[launchTpl];
  if(typeof RETAINER_CATEGORIES!=="undefined"){
    for(const cat of RETAINER_CATEGORIES){
      const catPhases=(cat.phases||[]).map(cp=>({
        name:cp.name||cp.phase||"",
        phase:cp.name||cp.phase||"",
        packages:(cp.packages||[]).map(pk=>({
          name:pk.package||pk.name||"",
          package:pk.package||pk.name||"",
          tasks:(pk.tasks||[]).map(tk=>({
            name:tk.t||tk.task||tk.name||"",
            task:tk.t||tk.task||tk.name||"",
            owner:tk.owner||"",
            planzeit:tk.min||tk.planzeit||tk.plan||0,
            plan:tk.min||tk.planzeit||tk.plan||0
          }))
        }))
      }));
      templates.push({id:"retainer_"+(cat.id||cat.name.toLowerCase().replace(/[^a-z0-9]/g,"_")),name:"Retainer: "+cat.name,type:"retainer_category",data:{phases:catPhases},created_at:new Date().toISOString(),updated_at:new Date().toISOString(),created_by:"System"});
    }
  // Batch insert
  const r=await fetch(SUPABASE_URL+"/rest/v1/templates",{
    method:"POST",
    headers:{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY,"Content-Type":"application/json","Prefer":"return=minimal"},
    body:JSON.stringify(templates)
  });
  if(r.ok){ tplCache=templates; console.log("Migrated",templates.length,"templates"); }
  else{ console.warn("Migration error",r.status); tplCache=[]; }
}
}

// === M5: Process Intelligence Dashboard ===
let piPeriod = "all";

function calcProcessMetrics(){
  const proj = A();
  if(!proj) return null;
  const now = Date.now();
  const periodMs = piPeriod==="month" ? 30*86400000 : piPeriod==="quarter" ? 90*86400000 : 0;
  const cutoff = periodMs ? now - periodMs : 0;
  let totalTasks=0, totalPlan=0, totalIst=0, tasksNoTime=0;
  const overPlan=[], underPlan=[], noTime=[], owners={};
  (proj.phases||[]).forEach((ph,pi)=>{
    (ph.packages||[]).forEach((pk,pki)=>{
      (pk.tasks||[]).forEach((tk,ti)=>{
        const plan = tk.min||0;
        let ist = 0;
        if(tk.timeLog && tk.timeLog.length){
          tk.timeLog.forEach(e=>{
            if(!e.start) return;
            const s = new Date(e.start).getTime();
            const en = e.end ? new Date(e.end).getTime() : now;
            if(cutoff && s < cutoff) return;
            ist += (en - s)/60000;
          });
        }
        ist = Math.round(ist);
        totalTasks++;
        totalPlan += plan;
        totalIst += ist;
        const info = {task:tk.t, phase:ph.name||("Phase "+(pi+1)), package:pk.name||"", plan, ist, owner:tk.owner||"‚Äì", path:pi+"_"+pki+"_"+ti};
        if(ist===0 && plan>0){ tasksNoTime++; noTime.push(info); }
        else if(ist > plan && plan>0){ overPlan.push({...info, diff:ist-plan, pct:Math.round(ist/plan*100)}); }
        else if(ist>0 && ist<=plan){ underPlan.push({...info, diff:plan-ist, pct:Math.round(ist/plan*100)}); }
        if(tk.owner){
          if(!owners[tk.owner]) owners[tk.owner]={name:tk.owner, plan:0, ist:0, tasks:0};
          owners[tk.owner].plan += plan;
          owners[tk.owner].ist += ist;
          owners[tk.owner].tasks++;
        }
      });
    });
  });
  overPlan.sort((a,b)=>b.diff-a.diff);
  underPlan.sort((a,b)=>b.diff-a.diff);
  const ownerList = Object.values(owners).sort((a,b)=>b.ist-a.ist);
  const efficiency = totalPlan>0 ? Math.round(totalIst/totalPlan*100) : 0;
  return {totalTasks, totalPlan, totalIst, efficiency, tasksNoTime, overPlan, underPlan, noTime, ownerList, projName:proj.name||"Projekt"};
}

function piColorClass(pct){
  if(pct<=100) return "pi-green";
  if(pct<=130) return "pi-yellow";
  return "pi-red";
}

function piBar(ist, plan){
  if(!plan) return "";
  const pct = Math.min(Math.round(ist/plan*100),200);
  const color = pct<=100?"#4ade80":pct<=130?"#fbbf24":"#f87171";
  return '<div class="pi-bar"><div class="pi-bar-fill" style="width:'+Math.min(pct,100)+'%;background:'+color+'"></div></div>';
}

function renderProcessDashboard(){
  const el = document.getElementById("processView");
  if(!el) return;
  const m = calcProcessMetrics();
  if(!m){ el.innerHTML='<div class="pi-empty">Kein aktives Projekt ausgew√§hlt.</div>'; return; }
  let h = '<div class="pi-dash">';
  h += '<div class="pi-controls">';
  h += '<span style="font-weight:600;font-size:15px">üìä Process Intelligence ‚Äì '+m.projName+'</span>';
  ["all","month","quarter"].forEach(p=>{
    const label = p==="all"?"Gesamt":p==="month"?"Letzter Monat":"Letztes Quartal";
    h += '<button class="pi-period' + (piPeriod===p?" active":"") + '" onclick="piPeriod=\''+p+'\';renderProcessDashboard()">'+label+'</button>';
  });
  h += '<button class="pi-export-btn" onclick="exportProcessReport()">üìã Export</button>';
  h += '</div>';
  // KPI cards
  h += '<div class="pi-cards">';
  h += '<div class="pi-card"><small>Tasks gesamt</small><h3>'+m.totalTasks+'</h3></div>';
  h += '<div class="pi-card"><small>Plan (min)</small><h3>'+m.totalPlan+'</h3></div>';
  h += '<div class="pi-card"><small>Ist (min)</small><h3>'+m.totalIst+'</h3></div>';
  const effColor = m.efficiency<=100?"#4ade80":m.efficiency<=130?"#fbbf24":"#f87171";
  h += '<div class="pi-card"><small>Effizienz</small><h3 style="color:'+effColor+'">'+m.efficiency+'%</h3></div>';
  h += '<div class="pi-card"><small>Ohne Zeiterfassung</small><h3 style="color:#fbbf24">'+m.tasksNoTime+'</h3></div>';
  h += '</div>';
  // Tables
  if(m.overPlan.length){
    h += '<div class="pi-section"><h3>‚ö†Ô∏è √úber-Plan Tasks</h3>';
    h += '<table class="pi-table"><tr><th>Task</th><th>Phase</th><th>Owner</th><th>Plan</th><th>Ist</th><th>Diff</th><th>%</th><th></th></tr>';
    m.overPlan.forEach(t=>{
      h += '<tr><td>'+t.task+'</td><td>'+t.phase+'</td><td>'+t.owner+'</td><td>'+t.plan+'</td><td class="'+piColorClass(t.pct)+'">'+t.ist+'</td><td class="pi-red">+'+t.diff+'</td><td class="'+piColorClass(t.pct)+'">'+t.pct+'%</td><td>'+piBar(t.ist,t.plan)+'</td></tr>';
    });
    h += '</table></div>';
  }
  if(m.underPlan.length){
    h += '<div class="pi-section"><h3>‚úÖ Effiziente Tasks</h3>';
    h += '<table class="pi-table"><tr><th>Task</th><th>Phase</th><th>Owner</th><th>Plan</th><th>Ist</th><th>Gespart</th><th>%</th><th></th></tr>';
    m.underPlan.forEach(t=>{
      h += '<tr><td>'+t.task+'</td><td>'+t.phase+'</td><td>'+t.owner+'</td><td>'+t.plan+'</td><td class="pi-green">'+t.ist+'</td><td class="pi-green">-'+t.diff+'</td><td class="pi-green">'+t.pct+'%</td><td>'+piBar(t.ist,t.plan)+'</td></tr>';
    });
    h += '</table></div>';
  }
  if(m.ownerList.length){
    h += '<div class="pi-section"><h3>üë• Mitarbeiter-Auslastung</h3>';
    h += '<table class="pi-table"><tr><th>Mitarbeiter</th><th>Tasks</th><th>Plan (min)</th><th>Ist (min)</th><th>Effizienz</th><th></th></tr>';
    m.ownerList.forEach(o=>{
      const eff = o.plan>0?Math.round(o.ist/o.plan*100):0;
      h += '<tr><td>'+o.name+'</td><td>'+o.tasks+'</td><td>'+o.plan+'</td><td>'+o.ist+'</td><td class="'+piColorClass(eff)+'">'+eff+'%</td><td>'+piBar(o.ist,o.plan)+'</td></tr>';
    });
    h += '</table></div>';
  }
  if(m.noTime.length){
    h += '<div class="pi-section"><h3>‚è±Ô∏è Tasks ohne Zeiterfassung</h3>';
    h += '<table class="pi-table"><tr><th>Task</th><th>Phase</th><th>Owner</th><th>Plan (min)</th></tr>';
    m.noTime.slice(0,20).forEach(t=>{
      h += '<tr><td>'+t.task+'</td><td>'+t.phase+'</td><td>'+t.owner+'</td><td>'+t.plan+'</td></tr>';
    });
    if(m.noTime.length>20) h += '<tr><td colspan="4" style="color:var(--dim)">... und '+(m.noTime.length-20)+' weitere</td></tr>';
    h += '</table></div>';
  }
  if(!m.overPlan.length && !m.underPlan.length && !m.noTime.length){
    h += '<div class="pi-empty">Noch keine Zeiterfassungsdaten vorhanden.<br>Starte den Timer bei einzelnen Tasks um Daten zu sammeln.</div>';
  }
  h += '</div>';
  el.innerHTML = h;
}

function exportProcessReport(){
  const m = calcProcessMetrics();
  if(!m) return;
  let txt = "PROCESS INTELLIGENCE REPORT\n";
  txt += "Projekt: "+m.projName+"\n";
  txt += "Zeitraum: "+(piPeriod==="all"?"Gesamt":piPeriod==="month"?"Letzter Monat":"Letztes Quartal")+"\n";
  txt += "================================\n\n";
  txt += "Tasks gesamt: "+m.totalTasks+"\n";
  txt += "Plan: "+m.totalPlan+" min | Ist: "+m.totalIst+" min\n";
  txt += "Effizienz: "+m.efficiency+"%\n";
  txt += "Ohne Zeiterfassung: "+m.tasksNoTime+"\n\n";
  if(m.overPlan.length){
    txt += "√úBER-PLAN TASKS:\n";
    m.overPlan.forEach(t=>{ txt += "  "+t.task+" ("+t.owner+"): Plan "+t.plan+" / Ist "+t.ist+" = "+t.pct+"%\n"; });
    txt += "\n";
  }
  if(m.underPlan.length){
    txt += "EFFIZIENTE TASKS:\n";
    m.underPlan.forEach(t=>{ txt += "  "+t.task+" ("+t.owner+"): Plan "+t.plan+" / Ist "+t.ist+" = "+t.pct+"%\n"; });
    txt += "\n";
  }
  if(m.ownerList.length){
    txt += "MITARBEITER:\n";
    m.ownerList.forEach(o=>{ const eff=o.plan>0?Math.round(o.ist/o.plan*100):0; txt += "  "+o.name+": "+o.tasks+" Tasks, Plan "+o.plan+" / Ist "+o.ist+" = "+eff+"%\n"; });
    txt += "\n";
  }
  try{ navigator.clipboard.writeText(txt).then(()=>alert("Report in Zwischenablage kopiert!")); }
  catch(e){ const w=window.open("","_blank"); if(w){ w.document.write("<pre>"+txt+"</pre>"); } }
}


// esc helper if not already defined


// ---------- REALTIME SUBSCRIPTION ----------
let realtimeChannel=null;
function setupRealtimeSubscription(){
  if(!sbClient||realtimeChannel)return;
  realtimeChannel=sbClient.channel('app_state_changes')
  .on('postgres_changes',{event:'UPDATE',schema:'public',table:'app_state',filter:'id=eq.main'},payload=>{
    if(syncInProgress)return;
    console.log('[Supabase] Realtime update received');
    const newData=payload.new.data;
    if(newData&&newData.clients){
      // Merge instead of overwrite
      if(lastKnownRemote){
        const localPayload={clients:DB.clients,activeClient:DB.activeClient,activeProject:DB.activeProject};
        const localStr=JSON.stringify(localPayload);
        const remoteStr=JSON.stringify(newData);
        if(localStr===remoteStr) return; // No difference

        const mergedClients=mergeClients(localPayload.clients, newData.clients, lastKnownRemote.clients||[]);
        DB.clients=mergedClients;
      } else {
        DB.clients=newData.clients||[];
      }
      lastKnownRemote=deepClone({clients:DB.clients,activeClient:DB.activeClient,activeProject:DB.activeProject});
      localStorage.setItem('lr3',JSON.stringify(DB));
      renderAll();
      toast('Daten von Teamkollege aktualisiert');
      updateSyncStatus('synced');
    }
  })
  .subscribe((status)=>{
    console.log('[Supabase] Realtime status:',status);
    if(status==='SUBSCRIBED')updateSyncStatus('synced');
  });
}

// ---------- SYNC STATUS INDICATOR ----------
function updateSyncStatus(status){
  const el=document.getElementById('syncStatus');
  if(!el)return;
  const icons={synced:'\u2601\uFE0F',syncing:'\uD83D\uDD04',error:'\u274C',offline:'\uD83D\uDCF4'};
  const tips={synced:'Synchronisiert',syncing:'Synchronisiere...',error:'Sync-Fehler',offline:'Offline-Modus'};
  el.textContent=icons[status]||'\u2601\uFE0F';
  el.title=tips[status]||status;
}


function mkProject(name,tpl,categories){
  const id='p'+Date.now()+'_'+Math.random().toString(36).substr(2,4);
  let phases;
  if(tpl==='retainer'&&categories&&categories.length){
    phases=[];
    categories.forEach(catId=>{
      const cat=RETAINER_CATEGORIES.find(c=>c.id===catId);
      if(cat){
        cat.phases.forEach(cp=>{
          phases.push(JSON.parse(JSON.stringify({name:cp.name,startDate:'',endDate:'',packages:cp.packages})));
        });
      }
    });
    if(!phases.length)phases=emptyPhases();
  }else if(tpl==='empty'){
    phases=emptyPhases();
  }else{
    phases=defaultPhases();
  }
  const proj={id,name,type:tpl||'launch',phases,states:{},docLinks:{},jfNotes:'',
    quickLinks:{homepage:'',instagram:'',linkedin:'',gdrive:'',claude:''},
    timeLog:[],activeTimer:null,
    startDate:new Date().toISOString().split('T')[0],launchDate:futDate(60),
    completed:false};
  // Auto-assign phase dates
  const pLen=proj.phases.length;
  const today=new Date();
  const PHASE_DAYS=tpl==='empty'?7:(tpl==='retainer'?10:5);
  proj.phases.forEach((p,i)=>{
    const s=new Date(today.getTime()+i*PHASE_DAYS*864e5);
    const e=new Date(today.getTime()+(i*PHASE_DAYS+PHASE_DAYS)*864e5);
    p.startDate=s.toISOString().split('T')[0];
    p.endDate=e.toISOString().split('T')[0];
  });
  if(pLen){const lastEnd=new Date(proj.phases[pLen-1].endDate);lastEnd.setDate(lastEnd.getDate()+2);proj.launchDate=lastEnd.toISOString().split('T')[0]}
  return proj;
}

function mkClientWithProject(clientName,tpl,categories){
  const c={id:'c'+Date.now()+'_'+Math.random().toString(36).substr(2,4),name:clientName,projects:[]};
  const projName=tpl==='retainer'?getRetainerMonthName():clientName+' Launch';
  const proj=mkProject(projName,tpl,categories);
  c.projects.push(proj);
  return c;
}

function getRetainerMonthName(){
  const months=['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
  const d=new Date();
  return'Retainer '+months[d.getMonth()]+' '+d.getFullYear();
}

// Legacy compat: mkClient wraps mkClientWithProject
function mkClient(n,tpl){return mkClientWithProject(n,tpl)}

function emptyPhases(){
  return[
    {name:'Phase 1',startDate:'',endDate:'',packages:[{name:'Paket 1',tasks:['Aufgabe 1']}]},
    {name:'Phase 2',startDate:'',endDate:'',packages:[{name:'Paket 1',tasks:['Aufgabe 1']}]},
    {name:'Phase 3',startDate:'',endDate:'',packages:[{name:'Paket 1',tasks:['Aufgabe 1']}]}
  ];
}
function futDate(d){const x=new Date();x.setDate(x.getDate()+d);return x.toISOString().split('T')[0]}
// A() now returns the active PROJECT (not client) ‚Äî this is key for backward compat
function A(){
  const client=DB.clients.find(c=>c.id===DB.activeClient);
  if(!client)return DB.clients[0]?.projects[0]||{phases:[],states:{},quickLinks:{},timeLog:[],docLinks:{}};
  const proj=client.projects.find(p=>p.id===DB.activeProject);
  return proj||client.projects[0]||{phases:[],states:{},quickLinks:{},timeLog:[],docLinks:{}};
}
// Get active client object
function AC(){return DB.clients.find(c=>c.id===DB.activeClient)||DB.clients[0]}

// ============================================================
// CLIENT MGMT
// ============================================================
let _selectedTpl='launch';
function addClient(){
  _selectedTpl='launch';
  const m=document.createElement('div');m.className='modal-overlay';
  m.innerHTML=`<div class="modal" style="max-width:440px">
    <h3 style="margin:0 0 2px">‚ú® Neuer Kunde</h3>
    <div class="modal-subtitle">Kunde anlegen und erstes Projekt erstellen</div>
    <div class="modal-label">Kundenname</div>
    <input id="newClientName" type="text" placeholder="z.B. Mustermann Coaching" style="margin-bottom:18px">
    <div class="modal-label">Projekt-Typ</div>
    <div class="tpl-grid" style="grid-template-columns:1fr 1fr 1fr">
      <div class="tpl-option active" id="tplLaunch" onclick="selectTpl('launch')">
        <span class="tpl-icon">üöÄ</span>
        <span class="tpl-label">Webinar Launch</span>
        <span style="font-size:10px;color:var(--text3)">8 Phasen ¬∑ 60+ Tasks</span>
      </div>
      <div class="tpl-option" id="tplRetainer" onclick="selectTpl('retainer')">
        <span class="tpl-icon">üîÑ</span>
        <span class="tpl-label">Retainer</span>
        <span style="font-size:10px;color:var(--text3)">Monatlicher Baukasten</span>
      </div>
      <div class="tpl-option" id="tplEmpty" onclick="selectTpl('empty')">
        <span class="tpl-icon">üìù</span>
        <span class="tpl-label">Leeres Projekt</span>
        <span style="font-size:10px;color:var(--text3)">3 Phasen ¬∑ Frei</span>
      </div>
    </div>
    <div id="retainerCategories" style="display:none;margin-top:12px">
      <div class="modal-label">Retainer-Baukasten ‚Äì w√§hle die Kategorien</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        ${RETAINER_CATEGORIES.map(cat=>`<label class="ret-cat-label" data-cat="${cat.id}">
          <input type="checkbox" value="${cat.id}" class="retCatCheck" style="display:none">
          <span class="ret-cat-icon">${cat.icon}</span>
          <span class="ret-cat-name">${cat.name}</span>
        </label>`).join('')}
      </div>
    </div>
    <div class="btn-row" style="margin-top:18px">
      <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button>
      <button class="btn-primary" onclick="confirmNewClient(this)">Anlegen</button>
    </div>
  </div>`;
  document.body.appendChild(m);
  setTimeout(()=>document.getElementById('newClientName').focus(),50);
  document.getElementById('newClientName').addEventListener('keydown',e=>{if(e.key==='Enter')confirmNewClient(m.querySelector('.btn-primary'))});
}
function selectTpl(which){
  _selectedTpl=which;
  ['tplLaunch','tplRetainer','tplEmpty'].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.classList.toggle('active',id==='tpl'+which.charAt(0).toUpperCase()+which.slice(1));
  });
  // Fix: handle naming
  document.getElementById('tplLaunch')?.classList.toggle('active',which==='launch');
  document.getElementById('tplRetainer')?.classList.toggle('active',which==='retainer');
  document.getElementById('tplEmpty')?.classList.toggle('active',which==='empty');
  const rc=document.getElementById('retainerCategories');
  if(rc)rc.style.display=which==='retainer'?'block':'none';
}
function confirmNewClient(btn){
  const m=btn.closest('.modal-overlay');
  const name=document.getElementById('newClientName').value.trim();
  if(!name){toast('Bitte Name eingeben');return}
  const tpl=_selectedTpl;
  let categories=[];
  if(tpl==='retainer'){
    categories=[...document.querySelectorAll('.retCatCheck:checked')].map(cb=>cb.value);
    if(!categories.length){toast('Mindestens eine Kategorie w√§hlen');return}
  }
  m.remove();
  const tplMap={launch:'webinar',retainer:'retainer',empty:'empty'};
  const c=mkClientWithProject(name,tplMap[tpl]||tpl,categories);
  DB.clients.push(c);DB.activeClient=c.id;DB.activeProject=c.projects[0].id;
  expandedClients.add(c.id);
  save();dashboardActive=false;renderAll();
  const msgs={launch:'Webinar-Launch angelegt',retainer:'Retainer angelegt',empty:'Leeres Projekt angelegt'};
  toast(msgs[tpl]||'Projekt angelegt');
}

// Add new project to existing client
function addProject(clientId){
  _selectedTpl='launch';
  const client=DB.clients.find(c=>c.id===clientId);
  if(!client)return;
  const m=document.createElement('div');m.className='modal-overlay';
  m.innerHTML=`<div class="modal" style="max-width:440px">
    <h3 style="margin:0 0 2px">üìÅ Neues Projekt</h3>
    <div class="modal-subtitle">Projekt f√ºr ${esc(client.name)}</div>
    <div class="modal-label">Projektname</div>
    <input id="newProjName" type="text" placeholder="z.B. Webinar M√§rz, Retainer Q2..." style="margin-bottom:18px">
    <div class="modal-label">Projekt-Typ</div>
    <div class="tpl-grid" style="grid-template-columns:1fr 1fr 1fr">
      <div class="tpl-option active" id="tplLaunch" onclick="selectTpl('launch')">
        <span class="tpl-icon">üöÄ</span><span class="tpl-label">Launch</span>
      </div>
      <div class="tpl-option" id="tplRetainer" onclick="selectTpl('retainer')">
        <span class="tpl-icon">üîÑ</span><span class="tpl-label">Retainer</span>
      </div>
      <div class="tpl-option" id="tplEmpty" onclick="selectTpl('empty')">
        <span class="tpl-icon">üìù</span><span class="tpl-label">Leer</span>
      </div>
    </div>
    <div id="retainerCategories" style="display:none;margin-top:12px">
      <div class="modal-label">Retainer-Baukasten</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        ${RETAINER_CATEGORIES.map(cat=>`<label class="ret-cat-label" data-cat="${cat.id}">
          <input type="checkbox" value="${cat.id}" class="retCatCheck" style="display:none">
          <span class="ret-cat-icon">${cat.icon}</span>
          <span class="ret-cat-name">${cat.name}</span>
        </label>`).join('')}
      </div>
    </div>
    ${client.projects.some(p=>!p.completed)?`<div style="margin-top:12px;padding:8px 10px;background:var(--surface2);border-radius:var(--radius-sm);font-size:11px;color:var(--text3)">üí° Du kannst auch ein bestehendes Projekt als Template nutzen: <select id="dupFromProj" style="font-size:11px;margin-top:4px;padding:2px 6px;border:1px solid var(--border);border-radius:4px"><option value="">‚Äì Kein Template ‚Äì</option>${client.projects.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('')}</select></div>`:''}
    <div class="btn-row" style="margin-top:18px">
      <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button>
      <button class="btn-primary" onclick="confirmNewProject('${clientId}',this)">Anlegen</button>
    </div>
  </div>`;
  document.body.appendChild(m);
  setTimeout(()=>document.getElementById('newProjName').focus(),50);
}
function confirmNewProject(clientId,btn){
  const m=btn.closest('.modal-overlay');
  const client=DB.clients.find(c=>c.id===clientId);
  if(!client)return;
  const name=document.getElementById('newProjName').value.trim();
  if(!name){toast('Bitte Name eingeben');return}
  const tpl=_selectedTpl;
  let categories=[];
  if(tpl==='retainer'){
    categories=[...document.querySelectorAll('.retCatCheck:checked')].map(cb=>cb.value);
    if(!categories.length){toast('Mindestens eine Kategorie w√§hlen');return}
  }
  // Check if duplicating from existing project
  const dupSel=document.getElementById('dupFromProj');
  const dupId=dupSel?dupSel.value:'';
  let proj;
  if(dupId){
    const src=client.projects.find(p=>p.id===dupId);
    if(src){
      proj=JSON.parse(JSON.stringify(src));
      proj.id='p'+Date.now()+'_'+Math.random().toString(36).substr(2,4);
      proj.name=name;
      proj.completed=false;
      // Reset all states
      proj.states={};
    }else{
      proj=mkProject(name,tpl==='launch'?'webinar':tpl,categories);
    }
  }else{
    proj=mkProject(name,tpl==='launch'?'webinar':tpl,categories);
  }
  m.remove();
  client.projects.push(proj);
  DB.activeClient=clientId;DB.activeProject=proj.id;
  expandedClients.add(clientId);
  save();dashboardActive=false;renderAll();
  toast('Projekt "'+name+'" angelegt');
}

// Duplicate retainer for next month
function duplicateRetainer(projId){
  const client=AC();if(!client)return;
  const src=client.projects.find(p=>p.id===projId);
  if(!src)return;
  const newProj=JSON.parse(JSON.stringify(src));
  newProj.id='p'+Date.now()+'_'+Math.random().toString(36).substr(2,4);
  // Increment month name
  const months=['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
  const curMonth=new Date().getMonth();
  const nextMonth=(curMonth+1)%12;
  const year=nextMonth===0?new Date().getFullYear()+1:new Date().getFullYear();
  newProj.name='Retainer '+months[nextMonth]+' '+year;
  newProj.states={};newProj.completed=false;
  newProj.startDate=new Date().toISOString().split('T')[0];
  newProj.launchDate=futDate(30);
  // Reset phase dates
  const today=new Date();
  newProj.phases.forEach((p,i)=>{
    const s=new Date(today.getTime()+i*10*864e5);
    const e=new Date(today.getTime()+(i*10+10)*864e5);
    p.startDate=s.toISOString().split('T')[0];
    p.endDate=e.toISOString().split('T')[0];
  });
  client.projects.push(newProj);
  // Mark old as completed
  src.completed=true;
  DB.activeProject=newProj.id;
  save();renderAll();
  toast('Neuer Retainer-Monat erstellt');
}

function switchClient(id){
  const client=DB.clients.find(c=>c.id===id);
  if(!client)return;
  DB.activeClient=id;
  expandedClients.add(id);
  // Switch to first non-completed project, or first project
  const activeProj=client.projects.find(p=>!p.completed)||client.projects[0];
  if(activeProj)DB.activeProject=activeProj.id;
  dashboardActive=false;save();renderAll();
}
function switchProject(clientId,projId,e){
  if(e)e.stopPropagation();
  DB.activeClient=clientId;DB.activeProject=projId;
  dashboardActive=false;save();renderAll();
}
function toggleClientExpand(id,e){
  if(e)e.stopPropagation();
  if(expandedClients.has(id))expandedClients.delete(id);else expandedClients.add(id);
  renderSidebar();
}
function delClient(id,e){e.stopPropagation();if(DB.clients.length<=1)return toast('Mind. 1 Kunde');if(!confirm('Kunde und alle Projekte l√∂schen?'))return;DB.clients=DB.clients.filter(c=>c.id!==id);if(DB.activeClient===id){DB.activeClient=DB.clients[0].id;const ap=DB.clients[0].projects[0];DB.activeProject=ap?ap.id:null}save();renderAll();toast('Gel√∂scht')}
function delProject(clientId,projId,e){
  e.stopPropagation();
  const client=DB.clients.find(c=>c.id===clientId);
  if(!client||client.projects.length<=1)return toast('Mind. 1 Projekt pro Kunde');
  if(!confirm('Projekt l√∂schen?'))return;
  client.projects=client.projects.filter(p=>p.id!==projId);
  if(DB.activeProject===projId)DB.activeProject=client.projects[0].id;
  save();renderAll();toast('Projekt gel√∂scht');
}
function showDashboard(){dashboardActive=true;renderAll()}
function toggleProjectComplete(){
  const p=A();if(!p)return;
  p.completed=!p.completed;save();renderAll();
  toast(p.completed?'Projekt abgeschlossen':'Projekt reaktiviert');
}

// ============================================================
// RENDER ALL
// ============================================================
function renderAll(){
  renderSidebar();
  const dv=document.getElementById('dashboardView');
  const cv=document.getElementById('clientView');
  if(dashboardActive){
    dv.classList.add('active');
    cv.classList.add('hidden');
    renderDashboard();
    // Deselect in sidebar
    document.querySelectorAll('.client-item').forEach(el=>el.classList.remove('active'));
  }else{
    dv.classList.remove('active');
    cv.classList.remove('hidden');
    renderTopbar();renderStats();renderTasks();renderDocs();renderCountdown();renderMiniTimeline();applyFilters();
  }
}

function renderSidebar(){
  const el=document.getElementById('clientList');
  el.innerHTML=DB.clients.map(c=>{
    const isExpanded=expandedClients.has(c.id);
    const isActive=c.id===DB.activeClient;
    const totalPct=clientPct(c);
    const arrow=isExpanded?'‚ñæ':'‚ñ∏';
    let h=`<div class="ci-group${isActive?' ci-group-active':''}">
      <div class="client-item${isActive&&!isExpanded?' active':''}" onclick="toggleClientExpand('${c.id}',event)">
        <span class="ci-arrow" style="font-size:10px;margin-right:4px;color:var(--text3)">${arrow}</span>
        <span class="ci-name">${esc(c.name)}</span>
        <span class="ci-pct">${totalPct}%</span>
        <span class="ci-del" onclick="delClient('${c.id}',event)">‚úï</span>
      </div>`;
    if(isExpanded){
      h+=`<div class="ci-projects">`;
      c.projects.forEach(proj=>{
        const pPct=projectPct(proj);
        const isActiveProj=proj.id===DB.activeProject&&isActive;
        const isCompleted=proj.completed;
        const typeIcon=proj.type==='retainer'?'üîÑ':proj.type==='empty'?'üìù':'üöÄ';
        h+=`<div class="proj-item${isActiveProj?' active':''}${isCompleted?' completed':''}" onclick="switchProject('${c.id}','${proj.id}',event)">
          <span style="font-size:10px;margin-right:3px">${typeIcon}</span>
          <span class="proj-name">${esc(proj.name)}</span>
          <span class="proj-pct">${pPct}%</span>
          <span class="proj-del" onclick="delProject('${c.id}','${proj.id}',event)">‚úï</span>
        </div>`;
      });
      h+=`<div class="proj-add" onclick="addProject('${c.id}')">+ Projekt</div>`;
      h+=`</div>`;
    }
    h+=`</div>`;
    return h;
  }).join('');
}
function projectPct(proj){let t=0,d=0;proj.phases.forEach((p,pi)=>p.packages.forEach((pk,pai)=>pk.tasks.forEach((task,ti)=>{t++;if((proj.states[`${pi}-${pai}-${ti}`]||'Offen')==='Erledigt')d++})));return t?Math.round(d/t*100):0}
function clientPct(c){let t=0,d=0;(c.projects||[]).forEach(proj=>{proj.phases.forEach((p,pi)=>p.packages.forEach((pk,pai)=>pk.tasks.forEach((task,ti)=>{t++;if((proj.states[`${pi}-${pai}-${ti}`]||'Offen')==='Erledigt')d++})))});return t?Math.round(d/t*100):0}

function renderTopbar(){
  const c=A(); // active project
  const client=AC(); // active client
  const projLabel=client?client.name+' ‚Üí '+c.name:c.name;
  document.getElementById('clientTitle').textContent=projLabel;
  document.title=`LaunchRamp ‚Äì ${projLabel}`;
  document.getElementById('launchDate').value=c.launchDate||'';
  if(!c.startDate)c.startDate=c.phases[0]?.startDate||new Date().toISOString().split('T')[0];
  document.getElementById('startDate').value=c.startDate;
  const ql=c.quickLinks||{};
  const qd=[
    {key:'homepage',label:'Homepage'},
    {key:'instagram',label:'Instagram'},
    {key:'linkedin',label:'LinkedIn'},
    {key:'gdrive',label:'Google Drive'},
    {key:'claude',label:'Claude Projekt'}
  ];
  document.getElementById('qlinks').innerHTML=qd.map(q=>{
    const url=ql[q.key]||'';
    return url
      ?`<span class="qlink active" onclick="window.open('${esc(url)}','_blank')" title="${esc(url)}">${q.label}<span class="qlink-edit" onclick="event.stopPropagation();editQuickLink('${q.key}')" title="Link bearbeiten">‚úèÔ∏è</span></span>`
      :`<span class="qlink" onclick="editQuickLink('${q.key}')" title="${q.label} verlinken">${q.label}</span>`;
  }).join('');
}
function editQuickLink(key){
  const c=A();if(!c.quickLinks)c.quickLinks={homepage:'',instagram:'',linkedin:'',gdrive:''};
  const labels={homepage:'Homepage URL',instagram:'Instagram URL',linkedin:'LinkedIn URL',gdrive:'Google Drive URL',claude:'Claude Projekt URL'};
  const cur=c.quickLinks[key]||'';
  const v=prompt(labels[key]+':',cur);
  if(v===null)return;
  c.quickLinks[key]=v.trim();save();renderTopbar();
  toast(v.trim()?'Link gespeichert':'Link entfernt');
}
function editTitle(){const s=document.getElementById('clientTitle'),i=document.getElementById('clientTitleInput');i.value=A().name;s.style.display='none';i.style.display='inline-block';i.focus();i.select()}
function saveTitle(){const s=document.getElementById('clientTitle'),i=document.getElementById('clientTitleInput'),v=i.value.trim()||'Projekt';s.style.display='';i.style.display='none';A().name=v;save();renderAll()}

function renderCountdown(){
  const c=A(),diff=Math.ceil((new Date(c.launchDate)-new Date())/864e5),el=document.getElementById('countdown');
  if(diff>14){el.textContent=diff+' Tage';el.style.cssText='background:var(--surface2);color:var(--text2)'}
  else if(diff>7){el.textContent=diff+' Tage';el.style.cssText='background:var(--yellow-bg);color:var(--yellow)'}
  else if(diff>0){el.textContent=diff+' Tage!';el.style.cssText='background:var(--red-bg);color:var(--red)'}
  else if(diff===0){el.textContent='LAUNCH DAY';el.style.cssText='background:var(--green-bg);color:var(--green)'}
  else{el.textContent='Launched';el.style.cssText='background:var(--green-bg);color:var(--green)'}
}

function setProjectStart(val){
  const c=A();
  c.startDate=val;
  save();renderAll();renderMiniTimeline();
  toast('Startdatum gesetzt');
}

function recalcDeadlines(){
  const c=A();
  const start=c.startDate?new Date(c.startDate):new Date();
  let cursor=new Date(start);
  c.phases.forEach(p=>{
    // Gesamtminuten aller Tasks in dieser Phase
    let totalMins=0;
    p.packages.forEach(pkg=>pkg.tasks.forEach(t=>totalMins+=(t.min||30)));
    // Umrechnung: 6h produktive Arbeit/Tag = 360min
    const workDays=Math.max(2,Math.ceil(totalMins/360));
    p.startDate=cursor.toISOString().split('T')[0];
    // Skip weekends
    let daysAdded=0;
    const endCursor=new Date(cursor);
    while(daysAdded<workDays){
      endCursor.setDate(endCursor.getDate()+1);
      const dow=endCursor.getDay();
      if(dow!==0&&dow!==6)daysAdded++;
    }
    p.endDate=endCursor.toISOString().split('T')[0];
    cursor=new Date(endCursor);
    cursor.setDate(cursor.getDate()+1); // 1 Tag Puffer zwischen Phasen
  });
  // Launch = Ende letzte Phase + 2 Tage
  const lastEnd=new Date(c.phases[c.phases.length-1].endDate);
  lastEnd.setDate(lastEnd.getDate()+2);
  c.launchDate=lastEnd.toISOString().split('T')[0];
  save();renderAll();
  toast('Deadlines berechnet: '+c.phases.length+' Phasen verteilt');
}

// ============================================================
// STATS
// ============================================================
function renderStats(){
  const c=A();let t=0,d=0,w=0,wa=0,tm=0,dm=0;
  c.phases.forEach((p,pi)=>p.packages.forEach((pk,pai)=>pk.tasks.forEach((task,ti)=>{
    t++;tm+=task.min||0;const s=c.states[`${pi}-${pai}-${ti}`]||'Offen';
    if(s==='Erledigt'){d++;dm+=task.min||0}if(s==='In Arbeit')w++;if(s==='Warte auf Kunde')wa++;
  })));
  document.getElementById('sT').textContent=t;
  document.getElementById('sD').textContent=d;
  document.getElementById('sDP').textContent=t?Math.round(d/t*100)+'%':'';
  document.getElementById('sW').textContent=w;
  document.getElementById('sWa').textContent=wa;
  document.getElementById('sH').textContent=Math.round(tm/60)+'h';
  document.getElementById('sHL').textContent=Math.round((tm-dm)/60)+'h √ºbrig';
  const dp=t?d/t*100:0,wp=t?w/t*100:0,wap=t?wa/t*100:0;
  document.getElementById('progressBar').innerHTML=`<div class="progress-seg" style="width:${dp}%;background:var(--green)"></div><div class="progress-seg" style="width:${wp}%;background:var(--yellow)"></div><div class="progress-seg" style="width:${wap}%;background:var(--pink)"></div>`;
}

// ============================================================
// TASKS VIEW
// ============================================================
function getPhaseHealth(phase,pct,done,total){
  const now=new Date();now.setHours(0,0,0,0);
  const GREEN='#16a34a',ORANGE='#ea580c',RED='#dc2626',BLUE='#6366f1',DONE_GREEN='#059669';
  // 100% done
  if(total>0&&done===total)return{color:DONE_GREEN,icon:'‚úì'};
  // No dates ‚Üí use original phase color
  if(!phase.startDate||!phase.endDate)return{color:phase.color,icon:''};
  const start=new Date(phase.startDate);start.setHours(0,0,0,0);
  const end=new Date(phase.endDate);end.setHours(0,0,0,0);
  // Future phase
  if(now<start)return{color:BLUE,icon:''};
  // Overdue: past end date with tasks open
  if(now>end&&done<total)return{color:RED,icon:'‚ö†Ô∏è'};
  // In progress: compare progress % to time elapsed %
  const totalDays=Math.max((end-start)/864e5,1);
  const elapsed=Math.min((now-start)/864e5,totalDays);
  const timePct=elapsed/totalDays*100;
  // On track or ahead
  if(pct>=timePct-10)return{color:GREEN,icon:''};
  // Behind schedule
  return{color:ORANGE,icon:'‚è≥'};
}
function renderTasks(){
  const c=A();let h='';
  c.phases.forEach((phase,pi)=>{
    let tt=0,dd=0;
    phase.packages.forEach((pk,pai)=>pk.tasks.forEach((t,ti)=>{tt++;if((c.states[`${pi}-${pai}-${ti}`]||'Offen')==='Erledigt')dd++}));
    const pct=tt?Math.round(dd/tt*100):0;
      let phasePlanMins=0,phaseActualMins=0;
      phase.packages.forEach((pk,pai)=>pk.tasks.forEach((t,ti)=>{phasePlanMins+=(t.min||30);phaseActualMins+=getTrackedMins(c,`${pi}-${pai}-${ti}`);}));
      const phaseTimeHtml=phasePlanMins>0?`<span class="phase-time">${phaseActualMins}/${phasePlanMins}min</span>`:"";;
    const dateStr=phase.startDate&&phase.endDate?`${fmtShort(phase.startDate)} ‚Äì ${fmtShort(phase.endDate)}`:'';
    const daysDiff=phase.startDate&&phase.endDate?Math.round((new Date(phase.endDate)-new Date(phase.startDate))/864e5):0;
    const pOpen=openPhases.has(pi);

    // Phase health color: green=on track, orange=behind, red=overdue, blue=future, bright green=done
    const phaseBarInfo=getPhaseHealth(phase,pct,dd,tt);

    h+=`<div class="phase-block" data-pi="${pi}" draggable="true" ondragstart="dragPhaseStart(event,${pi})" ondragend="dragPhaseEnd(event)" ondragover="dragPhaseOver(event,${pi})" ondragleave="dragPhaseLeave(event)" ondrop="dropPhase(event,${pi})">
      <div class="phase-head" onclick="toggleP(${pi})" style="border-left:3px solid ${phaseBarInfo.color}">
        <div class="phase-left">
          <span class="drag-handle" title="Phase verschieben" onmousedown="event.stopPropagation()">‚†ø</span>
          <span class="ph-chev${pOpen?' open':''}" id="pc${pi}">‚ñ∂</span>
          <span class="ph-tag" style="background:${phaseBarInfo.color}18;color:${phaseBarInfo.color}">${phase.id}</span>
          <span class="ph-name">${esc(phase.name)}</span>${phaseTimeHtml}
          ${phaseBarInfo.icon?`<span style="font-size:10px;margin-left:4px">${phaseBarInfo.icon}</span>`:''}
        </div>
        <div class="phase-right">
          ${dateStr?`<span class="phase-pct" style="font-size:10px">${dateStr} (${daysDiff}d)</span>`:''}
          <span class="phase-pct" style="color:${phaseBarInfo.color};font-weight:600">${dd}/${tt}</span>
          <div class="mini-bar" style="background:${phaseBarInfo.color}15"><div class="mini-fill" style="width:${pct}%;background:${phaseBarInfo.color}"></div></div>
          <div class="ph-actions" style="display:flex;gap:3px;align-items:center">
            <button class="btn sm" onclick="event.stopPropagation();openAddPackage(${pi})" style="font-size:10px;opacity:.7">+ Kategorie</button>
            <button class="btn sm" onclick="event.stopPropagation();openAddTask(${pi},0)" style="font-size:10px;opacity:.7">+ Task</button>
            <button class="btn sm" onclick="event.stopPropagation();editPhase(${pi})" title="Phase bearbeiten">‚úèÔ∏è</button>
            <button class="btn sm int-col" onclick="event.stopPropagation();duplicatePhase(${pi})" title="Phase duplizieren">üìã</button>
            <button class="btn sm danger int-col" onclick="event.stopPropagation();deletePhaseInline(${pi})" title="Phase l√∂schen" style="font-size:10px">üóëÔ∏è</button>
          </div>
        </div>
      </div>
      <div class="phase-body${pOpen?' open':''}" id="pb${pi}">`;

    phase.packages.forEach((pkg,pai)=>{
      const wKey=`${pi}_${pai}`;
      const wOpen=openPackages.has(wKey);
      // Package task count
      let ptt=0,pdd=0;
      pkg.tasks.forEach((t,ti)=>{ptt++;if((c.states[`${pi}-${pai}-${ti}`]||'Offen')==='Erledigt')pdd++});
      const ppct=ptt?Math.round(pdd/ptt*100):0;
        let pkgPlanMins=0,pkgActualMins=0;
        pkg.tasks.forEach((t,ti)=>{pkgPlanMins+=(t.min||30);const tid=`${pi}-${pai}-${ti}`;pkgActualMins+=getTrackedMins(c,tid);});
        const pkgTimeHtml=pkgPlanMins>0?`<span class="pkg-time">${pkgActualMins}/${pkgPlanMins}min</span>`:"";;

      h+=`<div class="wp-wrap" data-pi="${pi}" data-pai="${pai}" draggable="true" ondragstart="dragPkgStart(event,${pi},${pai})" ondragend="dragPkgEnd(event)" ondragover="dragPkgOver(event,${pi},${pai})" ondragleave="dragPkgLeave(event)" ondrop="dropPkg(event,${pi},${pai})">
      <div class="wp-head" onclick="toggleW(${pi},${pai})">
        <span class="drag-handle" title="Kategorie verschieben" onmousedown="event.stopPropagation()">‚†ø</span>
        <span class="wp-chev${wOpen?' open':''}" id="wc${pi}_${pai}">‚ñ∂</span>
        <span class="wp-name">${esc(pkg.name)}</span>${pkgTimeHtml}
        <span style="font-size:10px;color:var(--text3);margin-left:6px">${pdd}/${ptt}</span>
        ${ppct===100?'<span style="font-size:9px;color:var(--green);margin-left:4px">‚úì</span>':''}
        <button class="btn sm int-col" style="margin-left:auto;opacity:0;transition:opacity .15s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0" onclick="event.stopPropagation();renamePackage(${pi},${pai})">‚úèÔ∏è</button>
        <button class="btn sm int-col danger" style="opacity:0;transition:opacity .15s;font-size:9px" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0" onclick="event.stopPropagation();deletePackage(${pi},${pai})">‚úï</button>
      </div><div class="wp-body${wOpen?' open':''}" id="wb${pi}_${pai}">`;

      // Compute task deadlines based on phase dates + cumulative minutes
      let phaseTaskDeadlines=[];
      if(phase.startDate&&phase.endDate){
        const pS=new Date(phase.startDate),pE=new Date(phase.endDate);
        const pSpan=pE-pS;
        let cumMin=0,totalMin=0;
        phase.packages.forEach(pk=>pk.tasks.forEach(t=>totalMin+=(t.min||30)));
        phase.packages.forEach(pk=>pk.tasks.forEach(t=>{
          cumMin+=(t.min||30);
          const ratio=totalMin>0?cumMin/totalMin:1;
          const dl=new Date(pS.getTime()+ratio*pSpan);
          phaseTaskDeadlines.push(dl);
        }));
      }
      let flatIdx=(function(){let n=0;for(let x=0;x<pai;x++)n+=phase.packages[x].tasks.length;return n})();

      pkg.tasks.forEach((task,ti)=>{
        const id=`${pi}-${pai}-${ti}`;
        const st=c.states[id]||'Offen';
        const cc=st==='Erledigt'?'done':st==='In Arbeit'?'wip':st==='Warte auf Kunde'?'wait':'';
        const ci=st==='Erledigt'?'‚úì':st==='In Arbeit'?'‚óè':st==='Warte auf Kunde'?'‚óî':'';
        if(!task.links)task.links={};
        const mins=task.min||30;
        const pLink=task.links.prompt||'';
        const sLink=task.links.sop||'';
        // Deadline badge
        let dlBadge='';
        {const dl=task.customDeadline?new Date(task.customDeadline):(phaseTaskDeadlines.length>0&&flatIdx<phaseTaskDeadlines.length?phaseTaskDeadlines[flatIdx]:null);
        if(dl){
          const now=new Date();
          const daysLeft=Math.ceil((dl-now)/864e5);
          const dlStr=dl.toLocaleDateString('de-DE',{day:'numeric',month:'short'});
          if(st==='Erledigt'){
            dlBadge=`<span class="dl-badge dl-done" onclick="editDeadline(${pi},${pai},${ti},event)" style="cursor:pointer" title="Klick: Deadline √§ndern">${dlStr}</span>`;
          }else if(daysLeft>1){
            dlBadge=`<span class="dl-badge dl-ok" onclick="editDeadline(${pi},${pai},${ti},event)" style="cursor:pointer" title="Klick: Deadline √§ndern">${dlStr}</span>`;
          }else if(daysLeft>=0){
            dlBadge=`<span class="dl-badge dl-warn" onclick="editDeadline(${pi},${pai},${ti},event)" style="cursor:pointer" title="Klick: Deadline √§ndern">${dlStr}</span>`;
          }else{
            dlBadge=`<span class="dl-badge dl-over" onclick="editDeadline(${pi},${pai},${ti},event)" style="cursor:pointer" title="Klick: Deadline √§ndern">${dlStr} (${Math.abs(daysLeft)}d √ºber)</span>`;
          }
        }}
        flatIdx++;
        const tracked=getTrackedMins(c,id);
        const planPct=mins>0?Math.min(Math.round(tracked/mins*100),200):0;
        const planCol=planPct<=100?"green":planPct<=150?"yellow":"red";
        const planBarHtml=mins>0&&(tracked>0||st==="Erledigt")?`<span class="plan-bar" title="${tracked}/${mins}min (${planPct}%)"><span class="plan-bar-track"><span class="plan-bar-fill ${planCol}" style="width:${Math.min(planPct,100)}%"></span></span><span class="plan-bar-label">${tracked}/${mins}</span></span>`:"";;
        const isTimerOn=c.activeTimer&&c.activeTimer.taskId===id;
        const timerBtn=`<span class="timer-btn${isTimerOn?' running':''}" onclick="toggleTimer('${id}',event)" title="${isTimerOn?'Timer stoppen':'Timer starten'}">${isTimerOn?'‚èπ':'‚ñ∂'}${tracked?`<span class="tracked">${tracked}m</span>`:''}</span>`;
        const timeBtn=`<span class="time-btn" onclick="editTaskTime(${pi},${pai},${ti})" title="Zeitbudget anpassen">‚è± ${mins}m</span>`;
        const sched=task.scheduled;
        const calBtn=sched
          ?`<span class="cal-btn cal-scheduled" onclick="openGCal(${pi},${pai},${ti})" title="Zeitblock: ${fmtShort(sched.date)} ${sched.time}">üìÖ ${fmtShort(sched.date)}</span>`
          :`<span class="cal-btn" onclick="openGCal(${pi},${pai},${ti})" title="Zeitblock planen">üìÖ</span>`;
        const promptBtn=pLink
          ?`<span class="link-btn has-link" onclick="window.open('${esc(pLink)}','_blank')" title="${esc(pLink)}">üìã Prompt <span class="gear" onclick="event.stopPropagation();editTaskLink(${pi},${pai},${ti},'prompt')">‚öô</span></span>`
          :`<span class="link-btn empty int-col" onclick="editTaskLink(${pi},${pai},${ti},'prompt')">üìã Prompt</span>`;
        const sopBtn=sLink
          ?`<span class="link-btn has-link" onclick="window.open('${esc(sLink)}','_blank')" title="${esc(sLink)}">üé¨ SOP <span class="gear" onclick="event.stopPropagation();editTaskLink(${pi},${pai},${ti},'sop')">‚öô</span></span>`
          :`<span class="link-btn empty int-col" onclick="editTaskLink(${pi},${pai},${ti},'sop')">üé¨ SOP</span>`;
        h+=`<div class="task-row ${st==='Erledigt'?'done':''}" data-id="${id}" data-owner="${task.owner}" data-status="${st}" oncontextmenu="ctxShow(event,'${id}',${pi},${pai},${ti})">
          <div class="tcheck ${cc}" onclick="cycle('${id}')">${ci}</div>
          <div class="task-text"><span class="txt" onclick="editTask(${pi},${pai},${ti})">${esc(task.t)}</span>${task.ki?'<span class="ki-dot" title="Kunden-Input"></span>':''}</div>
          ${timerBtn}
          ${planBarHtml}
          ${timeBtn}
          ${calBtn}
          ${promptBtn}
          ${sopBtn}
          <div><select class="ssel" onchange="setSt('${id}',this.value)"><option ${st==='Offen'?'selected':''}>Offen</option><option ${st==='In Arbeit'?'selected':''}>In Arbeit</option><option ${st==='Warte auf Kunde'?'selected':''}>Warte auf Kunde</option><option ${st==='Review'?'selected':''}>Review</option><option ${st==='Erledigt'?'selected':''}>Erledigt</option></select></div>
          <select class="opill opill-${task.owner.toLowerCase()}" onchange="setOwner(${pi},${pai},${ti},this)">${['Mitch','Max','Hussein','Tobie','Team','Kunde'].map(o=>`<option${task.owner===o?' selected':''}>${o}</option>`).join('')}</select>
          ${dlBadge}
          <div class="task-actions int-col"><button class="task-action" onclick="editTask(${pi},${pai},${ti})" title="Bearbeiten">‚úèÔ∏è</button></div>
        </div>`;
      });
      h+=`<div class="add-row"><button class="add-btn" onclick="openAddTask(${pi},${pai})">+ Aufgabe</button></div></div></div>`;
    });
    // Add category button within phase
    h+=`<div class="add-row" style="margin-top:4px;margin-bottom:6px"><button class="add-btn" onclick="openAddPackage(${pi})" style="font-size:11px">+ Neue Kategorie</button></div>`;
    h+=`</div></div>`;
  });
  h+=`<div style="text-align:center;margin:12px 0 8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="add-btn" onclick="openNewPhase()" style="font-size:12px;padding:8px 18px;font-weight:600">+ Neue Phase</button>
    ${c.type==='retainer'?`<button class="add-btn" onclick="duplicateRetainer('${c.id}')" style="font-size:12px;padding:8px 18px;font-weight:600;border-color:var(--blue);color:var(--blue)">üîÑ N√§chsten Monat</button>`:''}
    <button class="add-btn" onclick="toggleProjectComplete()" style="font-size:11px;padding:6px 14px;opacity:.6">${c.completed?'‚Ü©Ô∏è Reaktivieren':'‚úÖ Abschlie√üen'}</button>
  </div>`;
  document.getElementById('tasksView').innerHTML=h;
}

function toggleP(pi){
  if(openPhases.has(pi))openPhases.delete(pi);else openPhases.add(pi);
  document.getElementById(`pb${pi}`).classList.toggle('open');
  document.getElementById(`pc${pi}`).classList.toggle('open');
}
function toggleW(pi,pai){
  const k=`${pi}_${pai}`;
  if(openPackages.has(k))openPackages.delete(k);else openPackages.add(k);
  document.getElementById(`wb${pi}_${pai}`).classList.toggle('open');
  document.getElementById(`wc${pi}_${pai}`).classList.toggle('open');
}

// Package (Kategorie) Management
function openAddPackage(pi){
  const name=prompt('Name der neuen Kategorie:');
  if(!name||!name.trim())return;
  const c=A();
  c.phases[pi].packages.push({name:name.trim(),tasks:[]});
  save();renderAll();toast('Kategorie hinzugef√ºgt');
  // Auto-open the phase and new package
  if(!openPhases.has(pi)){openPhases.add(pi)}
  const newPai=c.phases[pi].packages.length-1;
  openPackages.add(`${pi}_${newPai}`);
  renderTasks();applyFilters();
}
function renamePackage(pi,pai){
  const c=A();
  const name=prompt('Kategorie umbenennen:',c.phases[pi].packages[pai].name);
  if(!name||!name.trim())return;
  c.phases[pi].packages[pai].name=name.trim();
  save();renderTasks();applyFilters();toast('Kategorie umbenannt');
}
function deletePackage(pi,pai){
  if(!confirm('Kategorie und alle enthaltenen Aufgaben l√∂schen?'))return;
  A().phases[pi].packages.splice(pai,1);
  rebuildStates(A());save();renderAll();toast('Kategorie gel√∂scht');
}

// ============================================================
// DRAG & DROP: PHASES
// ============================================================
let dragPI=null;
function dragPhaseStart(e,pi){dragPI=pi;e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain','phase-'+pi);e.currentTarget.classList.add('dragging')}
function dragPhaseEnd(e){dragPI=null;e.currentTarget.classList.remove('dragging');document.querySelectorAll('.phase-block').forEach(el=>{el.classList.remove('drag-over-top','drag-over-bot')})}
function dragPhaseOver(e,pi){
  if(dragPI===null||dragPI===pi)return;
  e.preventDefault();e.dataTransfer.dropEffect='move';
  const el=e.currentTarget,r=el.getBoundingClientRect(),mid=r.top+r.height/2;
  el.classList.remove('drag-over-top','drag-over-bot');
  if(e.clientY<mid)el.classList.add('drag-over-top');else el.classList.add('drag-over-bot');
}
function dragPhaseLeave(e){e.currentTarget.classList.remove('drag-over-top','drag-over-bot')}
function dropPhase(e,targetPI){
  e.preventDefault();
  if(dragPI===null||dragPI===targetPI)return;
  const c=A();
  const el=e.currentTarget,r=el.getBoundingClientRect(),mid=r.top+r.height/2;
  const insertBefore=e.clientY<mid;
  // Move phase
  const phase=c.phases.splice(dragPI,1)[0];
  let newIdx=insertBefore?targetPI:targetPI+1;
  if(dragPI<targetPI)newIdx--;
  c.phases.splice(newIdx,0,phase);
  // Renumber phase IDs and names
  renumberPhases(c);
  // Rebuild states to match new indices
  rebuildStates(c);
  save();
  // Recalc deadlines automatically
  autoRecalcAfterReorder(c);
  renderAll();toast('Phase verschoben');
  dragPI=null;
}

// ============================================================
// DRAG & DROP: PACKAGES (within a phase)
// ============================================================
let dragPkg=null;
function dragPkgStart(e,pi,pai){
  e.stopPropagation(); // Prevent phase drag
  dragPkg={pi,pai};e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain','pkg-'+pi+'-'+pai);e.currentTarget.classList.add('dragging');
}
function dragPkgEnd(e){dragPkg=null;e.currentTarget.classList.remove('dragging');document.querySelectorAll('.wp-wrap').forEach(el=>{el.classList.remove('drag-over-top','drag-over-bot')})}
function dragPkgOver(e,pi,pai){
  if(!dragPkg||dragPkg.pi!==pi||(dragPkg.pi===pi&&dragPkg.pai===pai))return;
  e.preventDefault();e.stopPropagation();e.dataTransfer.dropEffect='move';
  const el=e.currentTarget,r=el.getBoundingClientRect(),mid=r.top+r.height/2;
  el.classList.remove('drag-over-top','drag-over-bot');
  if(e.clientY<mid)el.classList.add('drag-over-top');else el.classList.add('drag-over-bot');
}
function dragPkgLeave(e){e.currentTarget.classList.remove('drag-over-top','drag-over-bot')}
function dropPkg(e,targetPI,targetPAI){
  e.preventDefault();e.stopPropagation();
  if(!dragPkg||dragPkg.pi!==targetPI||(dragPkg.pi===targetPI&&dragPkg.pai===targetPAI))return;
  const c=A();
  const el=e.currentTarget,r=el.getBoundingClientRect(),mid=r.top+r.height/2;
  const insertBefore=e.clientY<mid;
  const srcPAI=dragPkg.pai;
  const pkg=c.phases[targetPI].packages.splice(srcPAI,1)[0];
  let newIdx=insertBefore?targetPAI:targetPAI+1;
  if(srcPAI<targetPAI)newIdx--;
  c.phases[targetPI].packages.splice(newIdx,0,pkg);
  rebuildStates(c);
  save();renderAll();toast('Kategorie verschoben');
  dragPkg=null;
}

// ============================================================
// AUTO-RECALC AFTER REORDER
// ============================================================
function autoRecalcAfterReorder(c){
  if(!c.startDate)return;
  const start=new Date(c.startDate);
  let cursor=new Date(start);
  c.phases.forEach(p=>{
    let totalMins=0;
    p.packages.forEach(pkg=>pkg.tasks.forEach(t=>totalMins+=(t.min||30)));
    const workDays=Math.max(2,Math.ceil(totalMins/360));
    p.startDate=cursor.toISOString().split('T')[0];
    let daysAdded=0;
    const endCursor=new Date(cursor);
    while(daysAdded<workDays){endCursor.setDate(endCursor.getDate()+1);const dow=endCursor.getDay();if(dow!==0&&dow!==6)daysAdded++}
    p.endDate=endCursor.toISOString().split('T')[0];
    cursor=new Date(endCursor);cursor.setDate(cursor.getDate()+1);
  });
  if(c.phases.length){
    const lastEnd=new Date(c.phases[c.phases.length-1].endDate);
    lastEnd.setDate(lastEnd.getDate()+2);
    c.launchDate=lastEnd.toISOString().split('T')[0];
  }
  save();
}

// ============================================================
// MANUAL DEADLINE EDIT
// ============================================================
function editDeadline(pi,pai,ti,evt){
  const c=A();const task=c.phases[pi].packages[pai].tasks[ti];
  const phase=c.phases[pi];
  // Compute auto-deadline if no custom one set
  if(!task.customDeadline&&phase.startDate&&phase.endDate){
    const pS=new Date(phase.startDate),pE=new Date(phase.endDate),pSpan=pE-pS;
    let cumMin=0,totalMin=0;
    phase.packages.forEach(pk=>pk.tasks.forEach(t=>totalMin+=(t.min||30)));
    phase.packages.forEach((pk,pki)=>pk.tasks.forEach((t,tki)=>{
      cumMin+=(t.min||30);
      if(pki===pai&&tki===ti)task.customDeadline=new Date(pS.getTime()+(totalMin>0?cumMin/totalMin:1)*pSpan).toISOString().split('T')[0];
    }));
  }
  // Use native date picker
  const inp=document.createElement('input');
  inp.type='date';
  inp.value=task.customDeadline||'';
  inp.style.cssText='position:fixed;opacity:0;pointer-events:none;top:0;left:0';
  document.body.appendChild(inp);
  inp.addEventListener('change',()=>{
    if(inp.value){task.customDeadline=inp.value;save();renderAll();toast('Deadline gesetzt')}
    inp.remove();
  });
  inp.addEventListener('blur',()=>setTimeout(()=>inp.remove(),200));
  inp.showPicker();

}

const SC=['Offen','In Arbeit','Warte auf Kunde','Erledigt'];
function cycle(id){const c=A(),cur=c.states[id]||"Offen";const nxt=SC[(SC.indexOf(cur)+1)%SC.length];c.states[id]=nxt;save();renderAll();logActivity("status_change",{task:id,oldStatus:cur,newStatus:nxt})}
function setSt(id,v){const old=A().states[id]||"Offen";A().states[id]=v;save();renderAll();logActivity("status_change",{task:id,oldStatus:old,newStatus:v})}
function setOwner(pi,pai,ti,sel){const c=A();c.phases[pi].packages[pai].tasks[ti].owner=sel.value;save();renderAll()}

// ============================================================
// TASK MODAL (Add / Edit)
// ============================================================
let taskCtx=null;
function openAddTask(pi,pai){
  taskCtx={mode:'add',pi,pai};
  document.getElementById('tmTitle').textContent='Neue Aufgabe';
  document.getElementById('tmName').value='';
  document.getElementById('tmOwner').value='Mitch';
  document.getElementById('tmMin').value='30';
  document.getElementById('tmVor').value='';
  document.getElementById('tmDel').style.display='none';
  openModal('taskModal');
  setTimeout(()=>document.getElementById('tmName').focus(),100);
}
function editTask(pi,pai,ti){
  const task=A().phases[pi].packages[pai].tasks[ti];
  taskCtx={mode:'edit',pi,pai,ti};
  document.getElementById('tmTitle').textContent='Aufgabe bearbeiten';
  document.getElementById('tmName').value=task.t;
  document.getElementById('tmOwner').value=task.owner;
  document.getElementById('tmMin').value=task.min||30;
  document.getElementById('tmVor').value=task.vor||'';
  document.getElementById('tmDel').style.display='';
  openModal('taskModal');
}
function saveTask(){
  if(!taskCtx)return;
  const name=document.getElementById('tmName').value.trim();
  if(!name)return;
  const c=A();
  const data={t:name,owner:document.getElementById('tmOwner').value,ki:false,vor:document.getElementById('tmVor').value.trim(),auto:'Niedrig',min:parseInt(document.getElementById('tmMin').value)||30,opt:false};
  if(taskCtx.mode==='add'){
    c.phases[taskCtx.pi].packages[taskCtx.pai].tasks.push(data);
    toast('Task hinzugef√ºgt');
  } else {
    const old=c.phases[taskCtx.pi].packages[taskCtx.pai].tasks[taskCtx.ti];
    data.ki=old.ki;
    data.links=old.links||{};
    c.phases[taskCtx.pi].packages[taskCtx.pai].tasks[taskCtx.ti]=data;
    toast('Task aktualisiert');
  }
  save();closeModal('taskModal');taskCtx=null;renderAll();
}
function deleteTask(){
  if(!taskCtx||taskCtx.mode!=='edit')return;
  if(!confirm('Task l√∂schen?'))return;
  const c=A();
  c.phases[taskCtx.pi].packages[taskCtx.pai].tasks.splice(taskCtx.ti,1);
  // Shift states
  rebuildStates(c);
  save();closeModal('taskModal');taskCtx=null;renderAll();
  toast('Task gel√∂scht');
}

function renumberPhases(c){
  c.phases.forEach((p,i)=>{
    const num=i+1;
    p.id='P'+num;
    // Update name: extract the descriptive part after "PHASE X: "
    const match=p.name.match(/^PHASE\s*\d+\s*:\s*(.+)$/i);
    if(match){
      p.name='PHASE '+num+': '+match[1];
    }
  });
}
function rebuildStates(c){
  const ns={};
  c.phases.forEach((p,pi)=>p.packages.forEach((pk,pai)=>pk.tasks.forEach((t,ti)=>{
    const oldKey=findOldStateKey(c,pi,pai,ti,t);
    if(oldKey&&c.states[oldKey])ns[`${pi}-${pai}-${ti}`]=c.states[oldKey];
  })));
  c.states=ns;
}
function findOldStateKey(c,pi,pai,ti,t){
  // Simple: just use the new index key if it exists
  const k=`${pi}-${pai}-${ti}`;
  if(c.states[k])return k;
  return null;
}

// ============================================================
// PHASE MODAL
// ============================================================
let phaseCtx=null;
function openNewPhase(){
  phaseCtx={mode:'add'};
  document.getElementById('pmTitle').textContent='Neue Phase';
  document.getElementById('pmName').value='';
  document.getElementById('pmColor').value='#6366f1';
  document.getElementById('pmStart').value='';
  document.getElementById('pmEnd').value='';
  document.getElementById('pmDel').style.display='none';
  openModal('phaseModal');
}
function editPhase(pi){
  const p=A().phases[pi];
  phaseCtx={mode:'edit',pi};
  document.getElementById('pmTitle').textContent='Phase bearbeiten';
  document.getElementById('pmName').value=p.name.replace(/^PHASE \d+:\s*/i,'');
  document.getElementById('pmColor').value=p.color;
  document.getElementById('pmStart').value=p.startDate||'';
  document.getElementById('pmEnd').value=p.endDate||'';
  document.getElementById('pmDel').style.display='';
  openModal('phaseModal');
}
function savePhase(){
  if(!phaseCtx)return;
  const name=document.getElementById('pmName').value.trim();
  if(!name)return;
  const c=A();
  if(phaseCtx.mode==='add'){
    const num=c.phases.length+1;
    c.phases.push({
      id:`P${num}`,
      name:name.toUpperCase().startsWith('PHASE')?name:`PHASE ${num}: ${name.toUpperCase()}`,
      color:document.getElementById('pmColor').value,
      startDate:document.getElementById('pmStart').value,
      endDate:document.getElementById('pmEnd').value,
      packages:[{name:'Arbeitspakete',tasks:[]}]
    });
    toast('Phase hinzugef√ºgt');
  } else {
    const p=c.phases[phaseCtx.pi];
    const newName=name.toUpperCase().startsWith('PHASE')?name:`${p.id}: ${name.toUpperCase()}`;
    p.name=newName;
    p.color=document.getElementById('pmColor').value;
    p.startDate=document.getElementById('pmStart').value;
    p.endDate=document.getElementById('pmEnd').value;
    toast('Phase aktualisiert');
  }
  save();closeModal('phaseModal');phaseCtx=null;renderAll();
}
function deletePhase(){
  if(!phaseCtx||phaseCtx.mode!=='edit')return;
  if(!confirm('Phase und alle Tasks l√∂schen?'))return;
  const c=A();c.phases.splice(phaseCtx.pi,1);
  renumberPhases(c);rebuildStates(c);
  save();closeModal('phaseModal');phaseCtx=null;renderAll();
  toast('Phase gel√∂scht');
}

function editTaskLink(pi,pai,ti,type){
  const c=A();
  const task=c.phases[pi].packages[pai].tasks[ti];
  if(!task.links)task.links={};
  const label=type==='prompt'?'Prompt-Link':'SOP/Video-Link';
  const current=task.links[type]||'';
  const url=prompt(`${label} f√ºr "${task.t}":`,current);
  if(url===null)return;
  task.links[type]=url.trim();
  save();renderAll();
  toast(url.trim()?`${label} gespeichert`:`${label} entfernt`);
}

function editTaskTime(pi,pai,ti){
  const c=A();
  const task=c.phases[pi].packages[pai].tasks[ti];
  const cur=task.min||30;
  const v=prompt('Zeitbudget (Minuten):',cur);
  if(v===null)return;
  task.min=Math.max(5,parseInt(v)||30);
  save();renderAll();
  toast('Zeitbudget: '+task.min+' Min');
}
function openGCal(pi,pai,ti){
  const c=A();
  const task=c.phases[pi].packages[pai].tasks[ti];
  const mins=task.min||30;
  const scheduled=task.scheduled||null;
  // Default: morgen, 09:00
  const tmrw=new Date();tmrw.setDate(tmrw.getDate()+1);
  const defDate=scheduled?scheduled.date:tmrw.toISOString().split('T')[0];
  const defTime=scheduled?scheduled.time:'09:00';
  const defMins=scheduled?scheduled.mins:mins;

  const ownerLC=(task.owner||'team').toLowerCase();
  const m=document.createElement('div');m.className='modal-overlay';
  m.innerHTML=`<div class="modal" style="max-width:400px">
    <h3 style="margin:0 0 2px">üîí Zeitblock planen</h3>
    <div class="modal-subtitle">${esc(task.t)}</div>
    <div style="display:flex;gap:10px;margin-bottom:16px">
      <div style="flex:1"><div class="modal-label">Datum</div>
        <input type="date" id="zbDate" value="${defDate}"></div>
      <div style="width:100px"><div class="modal-label">Uhrzeit</div>
        <input type="time" id="zbTime" value="${defTime}"></div>
      <div style="width:80px"><div class="modal-label">Dauer (min)</div>
        <input type="number" id="zbMins" value="${defMins}" min="5" step="5"></div>
    </div>
    <div class="modal-label">Verantwortlich</div>
    <div style="margin-bottom:16px"><span class="opill opill-${ownerLC}" style="cursor:default;background-image:none;padding-right:10px;font-size:11px">${task.owner||'Team'}</span></div>
    <div class="modal-preview">
      üìÖ <strong>${task.owner||'Team'}</strong> blockt sich <strong><span id="zbPreviewMins">${defMins}</span>min</strong> am <strong><span id="zbPreviewDate">${fmtShort(defDate)}</span></strong> um <strong><span id="zbPreviewTime">${defTime}</span></strong> Uhr
    </div>
    <div class="btn-row">
      ${scheduled?'<button class="btn-danger" onclick="removeScheduled('+pi+','+pai+','+ti+',this)">Entfernen</button>':''}
      <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button>
      <button class="btn-primary" onclick="confirmZeitblock(${pi},${pai},${ti},this)">üìÖ In Google Calendar</button>
    </div>
  </div>`;
  document.body.appendChild(m);
  // Live preview updates
  const updatePreview=()=>{
    const d=document.getElementById('zbDate').value;
    const t=document.getElementById('zbTime').value;
    const mn=document.getElementById('zbMins').value;
    document.getElementById('zbPreviewDate').textContent=d?fmtShort(d):'‚Äî';
    document.getElementById('zbPreviewTime').textContent=t||'‚Äî';
    document.getElementById('zbPreviewMins').textContent=mn||'‚Äî';
  };
  m.querySelector('#zbDate').addEventListener('input',updatePreview);
  m.querySelector('#zbTime').addEventListener('input',updatePreview);
  m.querySelector('#zbMins').addEventListener('input',updatePreview);
}
function confirmZeitblock(pi,pai,ti,btn){
  const c=A();const task=c.phases[pi].packages[pai].tasks[ti];
  const date=document.getElementById('zbDate').value;
  const time=document.getElementById('zbTime').value||'09:00';
  const mins=parseInt(document.getElementById('zbMins').value)||task.min||30;
  // Save scheduled info on task
  task.scheduled={date,time,mins,savedAt:new Date().toISOString()};
  save();
  // Build Google Calendar URL
  const title=encodeURIComponent('üîí '+task.t+' ¬∑ '+c.name);
  const desc=encodeURIComponent('Phase: '+c.phases[pi].name+'\\nOwner: '+(task.owner||'Team')+'\\nGesch√§tzt: '+mins+' Minuten\\n\\n‚Äî LaunchRamp Zeitblock');
  const [h,mn]=time.split(':').map(Number);
  const start=new Date(date+'T'+time+':00');
  const end=new Date(start.getTime()+mins*60000);
  const fmt=d=>d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}/,'');
  const url='https://calendar.google.com/calendar/render?action=TEMPLATE&text='+title+'&details='+desc+'&dates='+fmt(start)+'/'+fmt(end);
  window.open(url,'_blank');
  btn.closest('.modal-overlay').remove();
  renderAll();
  toast('Zeitblock geplant ‚úì');
}
function removeScheduled(pi,pai,ti,btn){
  const c=A();delete c.phases[pi].packages[pai].tasks[ti].scheduled;
  save();btn.closest('.modal-overlay').remove();renderAll();toast('Zeitblock entfernt');
}

function duplicatePhase(pi){
  const c=A();
  const orig=c.phases[pi];
  const clone=JSON.parse(JSON.stringify(orig));
  // Extract descriptive name
  const match=clone.name.match(/^PHASE\s*\d+\s*:\s*(.+)$/i);
  const descName=match?match[1]:clone.name;
  clone.id='P'+(c.phases.length+1);
  clone.name='PHASE '+(c.phases.length+1)+': '+descName;
  clone.startDate='';clone.endDate='';
  // Copy states for duplicated tasks
  orig.packages.forEach((pk,pai)=>pk.tasks.forEach((t,ti)=>{
    const oldKey=`${pi}-${pai}-${ti}`;
    // New tasks start fresh
  }));
  c.phases.splice(pi+1,0,clone);
  renumberPhases(c);
  rebuildStates(c);
  save();renderAll();
  toast('Phase dupliziert');
}
function deletePhaseInline(pi){
  const c=A();
  const phaseName=c.phases[pi]?c.phases[pi].name:'Phase';
  if(!confirm(`"${phaseName}" und alle zugeh√∂rigen Tasks l√∂schen?`))return;
  c.phases.splice(pi,1);
  renumberPhases(c);
  rebuildStates(c);
  openPhases.delete(pi);
  save();renderAll();
  toast('Phase gel√∂scht');
}

// ============================================================
// CONTEXT MENU
// ============================================================
let ctxData=null;
function ctxShow(e,id,pi,pai,ti){
  e.preventDefault();
  ctxData={id,pi,pai,ti};
  const m=document.getElementById('ctxMenu');
  m.style.left=Math.min(e.clientX,window.innerWidth-160)+'px';
  m.style.top=Math.min(e.clientY,window.innerHeight-150)+'px';
  m.classList.add('show');
}
function ctxHide(){document.getElementById('ctxMenu').classList.remove('show');ctxData=null}
function ctxEdit(){if(!ctxData)return;editTask(ctxData.pi,ctxData.pai,ctxData.ti);ctxHide()}
function ctxDuplicate(){
  if(!ctxData)return;
  const c=A(),t=c.phases[ctxData.pi].packages[ctxData.pai].tasks[ctxData.ti];
  c.phases[ctxData.pi].packages[ctxData.pai].tasks.splice(ctxData.ti+1,0,JSON.parse(JSON.stringify(t)));
  save();renderAll();toast('Dupliziert');ctxHide();
}
function ctxCal(){
  if(!ctxData)return;
  const t=A().phases[ctxData.pi].packages[ctxData.pai].tasks[ctxData.ti];
  openCalModal(ctxData.id,t.t,t.min);ctxHide();
}
function ctxLogTime(){
  if(!ctxData)return;
  addManualTime(ctxData.id);ctxHide();
}
function ctxDelete(){
  if(!ctxData)return;
  if(!confirm('Task l√∂schen?'))return;
  A().phases[ctxData.pi].packages[ctxData.pai].tasks.splice(ctxData.ti,1);
  rebuildStates(A());save();renderAll();toast('Gel√∂scht');ctxHide();
}
document.addEventListener('click',ctxHide);

// Retainer category toggle (event delegation)
document.addEventListener('click',function(e){
  const label=e.target.closest('.ret-cat-label');
  if(!label)return;
  e.preventDefault();e.stopPropagation();
  const cb=label.querySelector('input[type=checkbox]');
  if(cb){cb.checked=!cb.checked;label.classList.toggle('selected',cb.checked)}
});

// ============================================================
// MINI TIMELINE (Topbar)
// ============================================================
function renderMiniTimeline(){
  const c=A();
  const el=document.getElementById('miniTimeline');
  if(!el)return;
  const startD=c.startDate?new Date(c.startDate):new Date();
  const endD=new Date(c.launchDate);
  const now=new Date();
  const totalMs=endD-startD;
  if(totalMs<=0){el.innerHTML='';return}
  const elapsedMs=now-startD;
  const timePct=Math.max(0,Math.min(100,(elapsedMs/totalMs)*100));
  // Task progress
  let tt=0,dd=0;
  c.phases.forEach((p,pi)=>p.packages.forEach((pk,pai)=>pk.tasks.forEach((t,ti)=>{tt++;if((c.states[`${pi}-${pai}-${ti}`]||'Offen')==='Erledigt')dd++})));
  const taskPct=tt?Math.round(dd/tt*100):0;
  // Diff for color
  const diff=taskPct-timePct;
  const col=diff>=-5?'var(--green)':diff>=-20?'var(--yellow)':'var(--red)';
  const colBg=diff>=-5?'var(--green-bg)':diff>=-20?'var(--yellow-bg)':'var(--red-bg)';
  // Phase markers
  let markers='';
  c.phases.forEach(p=>{
    if(p.startDate){
      const pPct=Math.max(0,Math.min(100,((new Date(p.startDate)-startD)/totalMs)*100));
      markers+=`<div style="position:absolute;left:${pPct}%;top:0;bottom:0;width:1px;background:var(--border2);z-index:1" title="${esc(p.name)}"></div>`;
    }
  });
  el.innerHTML=`
    <div style="display:flex;align-items:center;gap:8px;width:100%">
      <div style="position:relative;flex:1;height:22px;background:var(--surface3);border-radius:11px;overflow:hidden;min-width:120px">
        ${markers}
        <div style="position:absolute;left:0;top:0;bottom:0;width:${timePct}%;background:var(--surface2);border-radius:9px;z-index:0" title="Soll: ${Math.round(timePct)}%"></div>
        <div style="position:absolute;left:0;top:4px;bottom:4px;width:${taskPct}%;background:${col};border-radius:7px;z-index:2;transition:width .3s" title="Ist: ${taskPct}%"></div>
        <div style="position:absolute;left:${timePct}%;top:0;bottom:0;width:2px;background:var(--red);z-index:3;border-radius:1px" title="Heute"></div>
        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--text);z-index:4;pointer-events:none;text-shadow:0 0 3px rgba(255,255,255,.8)">${taskPct}% erledigt ¬∑ Soll ${Math.round(timePct)}%</div>
      </div>
    </div>`;
}

function phasePct(c,pi){let t=0,d=0;c.phases[pi].packages.forEach((pk,pai)=>pk.tasks.forEach((task,ti)=>{t++;if((c.states[`${pi}-${pai}-${ti}`]||'Offen')==='Erledigt')d++}));return t?Math.round(d/t*100):0}

// ============================================================
// DOCS VIEW
// ============================================================
function renderDocs(){
  const c=A();let h='<div class="docs-grid">';
  DOCS.forEach(d=>{
    if(isCV&&d.int)return;
    const has=c.docLinks[d.id];
    h+=`<div class="doc-card ${has?'has-link':''} ${d.int?'int-doc':''}" onclick="openDocLink('${d.id}')">
      <div class="doc-icon">${d.icon}</div><div class="doc-name">${d.name}</div><div class="doc-desc">${d.desc}</div>
      <button class="doc-link-btn" onclick="event.stopPropagation();editLink('${d.id}','${d.name}')" title="Link bearbeiten">‚öô</button>
    </div>`;
  });
  h+='</div>';

  // Jourfix section
  if(!isCV){
    const jf=c.jourfix||{};
    const hasJF=jf.day&&jf.time;
    const jfLink=jf.meetLink||'';
    const dayNames=['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
    const jfDay=hasJF?`${dayNames[jf.day]}s`:''
    const jfTime=hasJF?jf.time:'';
    h+=`<div class="jf-section"><div class="sec-title" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">üìÖ Jourfix`;
    if(hasJF){
      if(jfLink){
        h+=`<a href="${esc(jfLink)}" target="_blank" style="font-size:11px;font-weight:600;color:var(--green);background:var(--green-bg);padding:2px 10px;border-radius:12px;text-decoration:none;cursor:pointer" title="Meeting √∂ffnen">${jfDay}, ${jfTime} Uhr</a>`;
      }else{
        h+=`<span style="font-size:11px;font-weight:600;color:var(--text2);background:var(--surface2);padding:2px 10px;border-radius:12px">${jfDay}, ${jfTime} Uhr</span>`;
      }
      h+=`<span style="font-size:10px;color:var(--text3);cursor:pointer" onclick="setupJourfix()" title="Jourfix √§ndern">‚úèÔ∏è</span>`;
      if(!jfLink){
        h+=`<span style="font-size:10px;color:var(--text3);cursor:pointer;border-bottom:1px dashed var(--border2)" onclick="editJFLink()" title="Meeting-Link hinzuf√ºgen">+ Link</span>`;
      }
    }else{
      h+=`<button class="btn sm" onclick="setupJourfix()" style="font-size:11px;background:var(--accent-bg);color:var(--accent);border-color:var(--accent)">+ Jourfix legen</button>`;
    }
    h+=`</div></div>`;
  }
  document.getElementById('docsView').innerHTML=h;
}
function saveJFLink(){/* legacy ‚Äì no longer used */}

let curDocId=null;
function editLink(id,name){curDocId=id;document.getElementById('linkName').textContent=name;document.getElementById('linkUrl').value=A().docLinks[id]||'';openModal('linkModal')}
function saveLink(){if(!curDocId)return;const u=document.getElementById('linkUrl').value.trim();if(u)A().docLinks[curDocId]=u;save();closeModal('linkModal');renderDocs();toast('Link gespeichert')}
function removeLink(){if(!curDocId)return;delete A().docLinks[curDocId];save();closeModal('linkModal');renderDocs()}
function openDocLink(id){const u=A().docLinks[id];if(u)window.open(u,'_blank');else toast('Noch kein Link konfiguriert')}

// ============================================================
// VIEWS
// ============================================================
function setView(v,tab){
  curView=v;
  document.querySelectorAll('.vtab').forEach(t=>t.classList.remove('active'));
  if(tab) tab.classList.add('active');
  document.getElementById('tasksView').classList.toggle('active',v==='tasks');
  document.getElementById('docsView').classList.toggle('active',v==='docs');
  document.getElementById('templatesView').classList.toggle('active',v==='templates');
  document.getElementById('processView').classList.toggle('active',v==='process');
  const showTask=v==='tasks';
  document.getElementById('filtersBar').style.display=showTask?'':'none';
  document.getElementById('statsRow').style.display=showTask?'':'none';
  document.getElementById('progressBar').style.display=showTask?'':'none';
  if(v==='templates') renderTemplates();
  if(v==='process') renderProcessDashboard();
}

function toggleCV(){
  isCV=!isCV;
  const b=document.getElementById('btnCV');
  b.textContent=isCV?'Team-Ansicht':'Kunden-Ansicht';
  b.classList.toggle('on',isCV);
  document.getElementById('content').classList.toggle('client-view',isCV);
  document.getElementById('filtersBar').classList.toggle('client-view',isCV);
  renderDocs();
}

// ============================================================
// FILTERS
// ============================================================
function fOwner(btn){btn.parentElement.querySelectorAll('[data-o]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');fO=btn.dataset.o;applyFilters()}
function fStatus(btn){btn.parentElement.querySelectorAll('[data-s]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');fS=btn.dataset.s;applyFilters()}
function applyFilters(){
  const q=document.getElementById('searchBox').value.toLowerCase();
  document.querySelectorAll('.task-row').forEach(r=>{
    const t=r.querySelector('.task-text').textContent.toLowerCase();
    r.style.display=((!q||t.includes(q))&&(fO==='all'||r.dataset.owner===fO)&&(fS==='all'||r.dataset.status===fS))?'':'none';
  });
}

// ============================================================
// CALENDAR
// ============================================================
let calData=null;
function openCalModal(id,name,dur){calData={id,name,dur:dur||60};document.getElementById('calTask').textContent=name;document.getElementById('calDur').value=dur||60;const t=new Date();t.setDate(t.getDate()+1);document.getElementById('calDate').value=t.toISOString().split('T')[0];openModal('calModal')}
function addToCal(){
  if(!calData)return;
  const d=document.getElementById('calDate').value,t=document.getElementById('calTime').value,dur=parseInt(document.getElementById('calDur').value)||60;
  const s=new Date(`${d}T${t}`),e=new Date(s.getTime()+dur*6e4);
  const f=d=>d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}/,'');
  window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(calData.name)}&dates=${f(s)}/${f(e)}&details=${encodeURIComponent('LaunchRamp ‚Äì '+A().name)}&sf=true&output=xml`,'_blank');
  closeModal('calModal');toast('Calendar ge√∂ffnet');
}
function setupJourfix(){
  const c=A();
  if(!c.jourfix)c.jourfix={};
  const jf=c.jourfix;
  const days=['Montag','Dienstag','Mittwoch','Donnerstag','Freitag'];
  const dayVals=[1,2,3,4,5];
  let dOpts=days.map((d,i)=>`<option value="${dayVals[i]}" ${jf.day==dayVals[i]?'selected':''}>${d}</option>`).join('');
  const cur=jf.time||'15:00';
  const isEdit=!!jf.day;
  const ml=jf.meetLink||'';
  const el=document.createElement('div');
  el.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999';
  el.innerHTML=`<div style="background:var(--surface);border-radius:var(--radius);padding:20px;width:340px;max-width:90vw;box-shadow:var(--shadow-lg)">
    <div style="font-size:14px;font-weight:700;margin-bottom:14px">üìÖ ${isEdit?'Jourfix √§ndern':'Jourfix legen'}</div>
    <div style="display:flex;gap:10px;margin-bottom:12px">
      <div style="flex:1"><div style="font-size:10px;color:var(--text3);font-weight:600;margin-bottom:3px">Wochentag</div>
        <select id="jfDay" style="width:100%;padding:7px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;background:var(--surface);color:var(--text)">${dOpts}</select></div>
      <div style="width:100px"><div style="font-size:10px;color:var(--text3);font-weight:600;margin-bottom:3px">Uhrzeit</div>
        <input type="time" id="jfTime" value="${cur}" style="width:100%;padding:7px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;background:var(--surface);color:var(--text)"></div>
    </div>
    <div style="margin-bottom:14px">
      <div style="font-size:10px;color:var(--text3);font-weight:600;margin-bottom:3px">Meeting-Link (optional)</div>
      <input type="url" id="jfMeetLink" value="${esc(ml)}" placeholder="https://meet.google.com/..." style="width:100%;padding:7px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;background:var(--surface);color:var(--text)">
    </div>
    <div style="display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap">
      ${isEdit?'<button class="btn danger sm" onclick="removeJourfix(this)" style="margin-right:auto">Entfernen</button>':''}
      <button class="btn sm" onclick="this.closest('div[style*=fixed]').remove()">Abbrechen</button>
      <button class="btn primary sm" onclick="confirmJourfix(this)">Speichern</button>
    </div>
  </div>`;
  document.body.appendChild(el);
}
function confirmJourfix(btn){
  const c=A();
  const day=parseInt(document.getElementById('jfDay').value);
  const time=document.getElementById('jfTime').value||'15:00';
  const meetLink=(document.getElementById('jfMeetLink').value||'').trim();
  const isNew=!(c.jourfix&&c.jourfix.day);
  c.jourfix={day,time,meetLink};
  save();
  btn.closest('div[style*=fixed]').remove();
  renderDocs();
  if(isNew){
    // Neuer Jourfix ‚Üí Google Calendar Link anbieten
    const dayNames=['','Montag','Dienstag','Mittwoch','Donnerstag','Freitag'];
    const gcalUrl=buildJourfixGcalUrl(c,day,time);
    const confirmEl=document.createElement('div');
    confirmEl.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999';
    confirmEl.innerHTML=`<div style="background:var(--surface);border-radius:var(--radius);padding:20px;width:340px;max-width:90vw;box-shadow:var(--shadow-lg);text-align:center">
      <div style="font-size:32px;margin-bottom:8px">‚úÖ</div>
      <div style="font-size:14px;font-weight:700;margin-bottom:4px">Jourfix gespeichert</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:16px">${dayNames[day]}s um ${time} Uhr</div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn sm" onclick="this.closest('div[style*=fixed]').remove()">Fertig</button>
        <button class="btn primary sm" onclick="window.open('${gcalUrl}','_blank');this.closest('div[style*=fixed]').remove()">üìÖ In Google Calendar eintragen</button>
      </div>
    </div>`;
    document.body.appendChild(confirmEl);
  }else{
    toast('Jourfix aktualisiert');
  }
}
function buildJourfixGcalUrl(c,day,time){
  const nxt=nextWeekday(day);
  const [h,m]=time.split(':').map(Number);
  const s=new Date(nxt);s.setHours(h,m,0,0);
  const e=new Date(s.getTime()+30*60000);
  const f=d=>d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}/,'');
  const gcalDays=['','MO','TU','WE','TH','FR','SA'];
  const title=encodeURIComponent(`${c.name} x Digital Sun Jourfix`);
  const details=encodeURIComponent('W√∂chentlicher Jourfix ‚Äì LaunchRamp');
  return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${f(s)}/${f(e)}&details=${details}&recur=RRULE:FREQ=WEEKLY;BYDAY=${gcalDays[day]}&sf=true&output=xml`;
}
function nextWeekday(targetDay){
  const d=new Date();d.setHours(0,0,0,0);
  const cur=d.getDay();
  let diff=targetDay-cur;
  if(diff<=0)diff+=7;
  d.setDate(d.getDate()+diff);
  return d;
}
function editJFLink(){
  const c=A();if(!c.jourfix)return;
  const cur=c.jourfix.meetLink||'';
  const v=prompt('Meeting-Link:',cur);
  if(v===null)return;
  c.jourfix.meetLink=v.trim();save();renderDocs();
  toast(v.trim()?'Meeting-Link gespeichert':'Meeting-Link entfernt');
}
function removeJourfix(btn){
  if(!confirm('Jourfix wirklich entfernen?'))return;
  A().jourfix={};save();
  btn.closest('div[style*=fixed]').remove();
  renderDocs();toast('Jourfix entfernt');
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  const el=document.getElementById('dashboardView');
  const now=new Date();
  const dayNames=['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];

  // Collect data across all clients
  let allOverdue=[];
  let allWaiting=[];
  let allThisWeek=[];
  let ownerMap={};
  const clientCards=[];

  DB.clients.forEach(c=>{
    let cTotal=0,cDone=0,cIP=0,cWait=0,cOpen=0,cEstMins=0,cDoneMins=0;
    let nearestLaunch=null;
    (c.projects||[]).forEach(proj=>{
      if(proj.completed)return; // skip completed for dashboard urgency
      let total=0,done=0,inProgress=0,waiting=0,open=0,estMins=0,doneMins=0;
      proj.phases.forEach((p,pi)=>{
        const phaseEnd=p.endDate?new Date(p.endDate):null;
        const isOverdue=phaseEnd&&phaseEnd<now;
        p.packages.forEach((pk,pai)=>pk.tasks.forEach((task,ti)=>{
          total++;
          const key=`${pi}-${pai}-${ti}`;
          const st=proj.states[key]||'Offen';
          const mins=task.min||30;
          estMins+=mins;
          const owner=task.owner||'?';
          if(!ownerMap[owner])ownerMap[owner]={total:0,done:0,active:0,waiting:0,mins:0,doneMins:0};
          ownerMap[owner].total++;
          ownerMap[owner].mins+=mins;

          if(st==='Erledigt'){done++;ownerMap[owner].done++;ownerMap[owner].doneMins+=mins;doneMins+=mins}
          else if(st==='In Arbeit'){inProgress++;ownerMap[owner].active++}
          else if(st==='Warte auf Kunde'){
            waiting++;ownerMap[owner].waiting++;
            allWaiting.push({client:c.name,clientId:c.id,task:task.t,owner,phase:p.name});
          }
          else{open++}

          if(st!=='Erledigt'&&isOverdue){
            const daysOver=Math.ceil((now-phaseEnd)/864e5);
            allOverdue.push({client:c.name,clientId:c.id,task:task.t,owner,phase:p.name,daysOver});
          }
          if(st!=='Erledigt'&&phaseEnd){
            const daysLeft=Math.ceil((phaseEnd-now)/864e5);
            if(daysLeft>=0&&daysLeft<=7){
              allThisWeek.push({client:c.name,clientId:c.id,task:task.t,owner,phase:p.name,daysLeft});
            }
          }
        }));
      });
      cTotal+=total;cDone+=done;cIP+=inProgress;cWait+=waiting;cOpen+=open;cEstMins+=estMins;cDoneMins+=doneMins;
      const ld=Math.ceil((new Date(proj.launchDate||futDate(30))-now)/864e5);
      if(nearestLaunch===null||ld<nearestLaunch)nearestLaunch=ld;
    });
    const pct=cTotal?Math.round(cDone/cTotal*100):0;
    const activeProjects=(c.projects||[]).filter(p=>!p.completed).length;
    const jf=(c.projects||[]).find(p=>p.jourfix&&p.jourfix.day);
    clientCards.push({id:c.id,name:c.name,pct,total:cTotal,done:cDone,inProgress:cIP,waiting:cWait,open:cOpen,estMins:cEstMins,doneMins:cDoneMins,
      launchDiff:nearestLaunch||0,activeProjects,
      jf:jf&&jf.jourfix.day?`${dayNames[jf.jourfix.day]} ${jf.jourfix.time}`:'‚Äì'});
  });

  allOverdue.sort((a,b)=>b.daysOver-a.daysOver);
  allThisWeek.sort((a,b)=>a.daysLeft-b.daysLeft);

  let h=`<div class="dash-header"><div>
    <div class="dash-title">Dashboard</div>
    <div class="dash-subtitle">${DB.clients.length} Kunde${DB.clients.length!==1?'n':''} ¬∑ ${new Date().toLocaleDateString('de-DE',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
  </div></div>`;

  // Client Cards
  h+=`<div class="dash-grid">`;
  clientCards.forEach(c=>{
    const barColor=c.pct>=80?'var(--green)':c.pct>=40?'var(--accent)':'var(--text3)';
    const pctBg=c.pct>=80?'var(--green-bg)':c.pct>=40?'var(--accent-bg)':'var(--surface2)';
    const pctCol=c.pct>=80?'var(--green)':c.pct>=40?'var(--accent)':'var(--text2)';
    const launchLabel=c.launchDiff>0?`${c.launchDiff}d bis Launch`:c.launchDiff===0?'LAUNCH DAY':'Launched';
    h+=`<div class="dash-card" onclick="switchClient('${c.id}')">
      <div class="dash-card-header">
        <span class="dash-card-name">${esc(c.name)}</span>
        <span class="dash-card-pct" style="background:${pctBg};color:${pctCol}">${c.pct}%</span>
      </div>
      <div class="dash-card-bar"><div class="dash-card-fill" style="width:${c.pct}%;background:${barColor}"></div></div>
      <div class="dash-card-meta">
        <span>‚úÖ ${c.done}/${c.total}</span>
        <span>üîÑ ${c.inProgress}</span>
        <span style="color:var(--pink)">‚è≥ ${c.waiting}</span>
        <span>üìÅ ${c.activeProjects||0} Projekte</span>
        <span>${launchLabel}</span>
      </div>
    </div>`;
  });
  h+=`</div>`;

  // Overdue Tasks
  if(allOverdue.length){
    h+=`<div class="dash-section">
      <div class="dash-section-title">üî¥ √úberf√§llig <span class="badge" style="background:var(--red)">${allOverdue.length}</span></div>
      <table class="dash-table"><thead><tr><th>Kunde</th><th>Task</th><th>Phase</th><th>Owner</th><th>√úberf√§llig</th></tr></thead><tbody>`;
    allOverdue.slice(0,15).forEach(t=>{
      h+=`<tr><td><span class="client-link" onclick="switchClient('${t.clientId}')">${esc(t.client)}</span></td>
        <td>${esc(t.task)}</td><td style="font-size:11px;color:var(--text3)">${esc(t.phase)}</td>
        <td>${esc(t.owner)}</td><td style="color:var(--red);font-weight:600">${t.daysOver}d</td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }

  // Waiting on Client
  if(allWaiting.length){
    h+=`<div class="dash-section">
      <div class="dash-section-title">‚è≥ Warte auf Kunde <span class="badge" style="background:var(--pink)">${allWaiting.length}</span></div>
      <table class="dash-table"><thead><tr><th>Kunde</th><th>Task</th><th>Phase</th><th>Owner</th></tr></thead><tbody>`;
    allWaiting.forEach(t=>{
      h+=`<tr><td><span class="client-link" onclick="switchClient('${t.clientId}')">${esc(t.client)}</span></td>
        <td>${esc(t.task)}</td><td style="font-size:11px;color:var(--text3)">${esc(t.phase)}</td>
        <td>${esc(t.owner)}</td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }

  // This Week Deadlines
  if(allThisWeek.length){
    h+=`<div class="dash-section">
      <div class="dash-section-title">üìÖ Diese Woche f√§llig <span class="badge" style="background:var(--yellow)">${allThisWeek.length}</span></div>
      <table class="dash-table"><thead><tr><th>Kunde</th><th>Task</th><th>Phase</th><th>Owner</th><th>In</th></tr></thead><tbody>`;
    allThisWeek.slice(0,20).forEach(t=>{
      const urgColor=t.daysLeft<=2?'var(--red)':t.daysLeft<=4?'var(--yellow)':'var(--text2)';
      h+=`<tr><td><span class="client-link" onclick="switchClient('${t.clientId}')">${esc(t.client)}</span></td>
        <td>${esc(t.task)}</td><td style="font-size:11px;color:var(--text3)">${esc(t.phase)}</td>
        <td>${esc(t.owner)}</td><td style="color:${urgColor};font-weight:600">${t.daysLeft}d</td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }

  // Owner Workload
  const owners=Object.entries(ownerMap).sort((a,b)=>b[1].total-a[1].total);
  if(owners.length){
    h+=`<div class="dash-section">
      <div class="dash-section-title">üë• Workload pro Owner</div>
      <div class="dash-owner-grid">`;
    owners.forEach(([name,d])=>{
      const pct=d.total?Math.round(d.done/d.total*100):0;
      const hrs=Math.round(d.mins/60);
      const doneHrs=Math.round(d.doneMins/60);
      h+=`<div class="dash-owner-card">
        <div class="dash-owner-name">${esc(name)}</div>
        <div class="dash-owner-stats">
          <span>‚úÖ ${d.done}/${d.total}</span>
          <span>üîÑ ${d.active}</span>
          <span>‚è≥ ${d.waiting}</span>
          <span>${doneHrs}/${hrs}h</span>
        </div>
        <div class="dash-owner-bar"><div class="dash-owner-fill" style="width:${pct}%"></div></div>
      </div>`;
    });
    h+=`</div></div>`;
  }

  if(!DB.clients.length){
    h+=`<div class="dash-empty">Noch keine Kunden angelegt. Klick auf "+ Neuer Kunde" um loszulegen.</div>`;
  }

  el.innerHTML=h;
}

// ============================================================
// TIME TRACKER
// ============================================================
function getTrackedMins(c,taskId){
  if(!c.timeLog)return 0;
  return Math.round(c.timeLog.filter(e=>e.taskId===taskId).reduce((s,e)=>s+(e.mins||0),0));
}
let timerInterval=null;
function toggleTimer(taskId,evt){
  evt.stopPropagation();
  const c=A();
  if(!c.timeLog)c.timeLog=[];
  if(c.activeTimer&&c.activeTimer.taskId===taskId){
    // Stop timer
    const elapsed=Math.round((Date.now()-c.activeTimer.startTime)/60000);
    if(elapsed>0){
      c.timeLog.push({taskId,start:c.activeTimer.startTime,end:Date.now(),mins:elapsed,manual:false});
    }
    c.activeTimer=null;
    if(timerInterval){clearInterval(timerInterval);timerInterval=null}
    save();renderTasks();applyFilters();
    toast(`Timer gestoppt: ${elapsed}m erfasst`);
    logActivity("timer_stop",{task:taskId,duration:elapsed+"m"});
  }else{
    // Stop any running timer first
    if(c.activeTimer){
      const prev=c.activeTimer;
      const elapsed=Math.round((Date.now()-prev.startTime)/60000);
      if(elapsed>0){
        c.timeLog.push({taskId:prev.taskId,start:prev.startTime,end:Date.now(),mins:elapsed,manual:false});
      }
    }
    c.activeTimer={taskId,startTime:Date.now()};
    logActivity("timer_start",{task:taskId});
    if(timerInterval)clearInterval(timerInterval);
    timerInterval=setInterval(()=>{
      // Update running timer display
      const btn=document.querySelector('.timer-btn.running');
      if(btn&&c.activeTimer){
        const el=Math.round((Date.now()-c.activeTimer.startTime)/60000);
        const tracked=getTrackedMins(c,taskId);
        const span=btn.querySelector('.tracked');
        if(span)span.textContent=`${tracked+el}m`;
        else{const s=document.createElement('span');s.className='tracked';s.textContent=`${tracked+el}m`;btn.appendChild(s)}
      }
    },15000);
    save();renderTasks();applyFilters();
    toast('Timer l√§uft');
  }
}
function addManualTime(taskId){
  const c=A();
  if(!c.timeLog)c.timeLog=[];
  const val=prompt('Minuten nachtr√§glich eintragen:','30');
  if(val===null)return;
  const mins=parseInt(val);
  if(isNaN(mins)||mins<=0)return toast('Ung√ºltige Eingabe');
  c.timeLog.push({taskId,start:Date.now(),end:Date.now(),mins,manual:true});
  save();renderTasks();applyFilters();
  toast(`${mins}m manuell erfasst`);
}

// ============================================================
// EXPORT
// ============================================================
function exportReport(){
  const c=A();let t=0,d=0,w=0,wa=0,tm=0,dm=0;const ps=[];
  c.phases.forEach((p,pi)=>{let pt=0,pd=0;p.packages.forEach((pk,pai)=>pk.tasks.forEach((task,ti)=>{
    t++;pt++;tm+=task.min||0;const s=c.states[`${pi}-${pai}-${ti}`]||'Offen';
    if(s==='Erledigt'){d++;pd++;dm+=task.min||0}if(s==='In Arbeit')w++;if(s==='Warte auf Kunde')wa++;
  }));ps.push({name:p.name,t:pt,d:pd,p:pt?Math.round(pd/pt*100):0})});
  const pct=t?Math.round(d/t*100):0,dl=Math.ceil((new Date(c.launchDate)-new Date())/864e5);
  let r=`LAUNCHRAMP REPORT\n${'‚ïê'.repeat(40)}\nKunde: ${c.name}\nDatum: ${new Date().toLocaleDateString('de-DE')}\nLaunch: ${new Date(c.launchDate).toLocaleDateString('de-DE')} (${dl>0?dl+' Tage':'Launched'})\n\nFORTSCHRITT: ${pct}% (${d}/${t})\nIn Arbeit: ${w} ¬∑ Wartend: ${wa}\nAufwand: ${Math.round(dm/60)}h / ${Math.round(tm/60)}h\n\n`;
  ps.forEach(p=>{r+=`${p.name}\n[${'‚ñà'.repeat(Math.round(p.p/5))}${'‚ñë'.repeat(20-Math.round(p.p/5))}] ${p.p}%\n`});
  navigator.clipboard.writeText(r).then(()=>toast('Report kopiert')).catch(()=>toast('Fehler'));
}

// ============================================================
// UTILS
// ============================================================
function openModal(id){document.getElementById(id).classList.add('show')}
function closeModal(id){document.getElementById(id).classList.remove('show')}
function toast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2200)}
function nextDay(d){const x=new Date();x.setDate(x.getDate()+((d+7-x.getDay())%7||7));return x.toISOString().split('T')[0]}
function fmtShort(d){if(!d)return'';return new Date(d).toLocaleDateString('de-DE',{day:'numeric',month:'short'})}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// Close modals on backdrop click
document.querySelectorAll('.modal-bg').forEach(bg=>{bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('show')})});

// INIT
load();
// Auto-open first phase and all its packages
openPhases.add(0);
const firstClient=A();
if(firstClient&&firstClient.phases[0]){
  firstClient.phases[0].packages.forEach((_,pai)=>openPackages.add(`0_${pai}`));
}
renderAll();
</script>
</body>
</html>
